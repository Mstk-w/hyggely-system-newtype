<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#8B4513">
  <title>Hyggelyã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥å°‚é–€åº— ã”äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ  v5.3.2</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    body {
      background: linear-gradient(135deg, #fff8f0 0%, #f5e6d3 100%);
      color: #2c1810;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      line-height: 1.6;
      min-height: 100vh;
    }
    .container { max-width: 800px; margin: 0 auto; padding: 10px; }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      margin: 1rem 0;
      padding: 2rem 1rem;
      border-radius: 15px;
      background: linear-gradient(135deg, #ffffff 0%, #faf7f2 100%);
      box-shadow: 0 8px 30px rgba(139, 69, 19, 0.15);
      text-align: center;
    }
    .header h1 {
      color: #8B4513;
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    /* ã‚«ãƒ¼ãƒ‰ */
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(139, 69, 19, 0.1);
      margin-bottom: 1.5rem;
      background: #ffffff;
      transition: all 0.3s ease;
    }
    .card:hover {
      box-shadow: 0 12px 35px rgba(139, 69, 19, 0.15);
    }
    .card-header {
      padding: 1.5rem;
      background: linear-gradient(135deg, #8B4513 0%, #a0522d 100%);
      color: white;
      border-radius: 15px 15px 0 0;
    }
    .card-body { padding: 1.5rem; }
    
    /* ãƒ•ã‚©ãƒ¼ãƒ  */
    .form-control, .form-select {
      border-radius: 10px;
      border: 2px solid #e8dcc6;
      padding: 0.8rem 1rem;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    .form-control:focus, .form-select:focus {
      border-color: #8B4513;
      box-shadow: 0 0 0 0.2rem rgba(139, 69, 19, 0.15);
    }
    .form-control:valid {
      border-color: #28a745;
    }
    .form-control:invalid {
      border-color: #dc3545;
    }
    
    /* ãƒœã‚¿ãƒ³ */
    .btn-primary {
      background: linear-gradient(135deg, #8B4513 0%, #a0522d 100%);
      border: none;
      font-weight: 600;
      padding: 1rem 2rem;
      border-radius: 10px;
      transition: all 0.3s ease;
    }
    .btn-primary:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(139, 69, 19, 0.3);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      transform: none;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    .table { 
      background: #ffffff; 
      border-radius: 10px; 
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    .table th {
      background: linear-gradient(135deg, #f8f6f0 0%, #f0ede5 100%);
      font-weight: 700;
      border: none;
      padding: 1rem 0.5rem;
      font-size: 0.9rem;
    }
    .table td { 
      padding: 0.8rem 0.5rem; 
      border-color: #f0f0f0;
      vertical-align: middle;
    }
    
    /* å—å–æ™‚é–“é¸æŠã®æ”¹å–„ */
    .time-selection {
      margin-bottom: 1rem;
    }
    .time-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .time-option {
      padding: 0.75rem 0.5rem;
      border: 2px solid #e8dcc6;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .time-option:hover {
      border-color: #8B4513;
      background: rgba(139, 69, 19, 0.05);
    }
    .time-option.selected {
      border-color: #8B4513;
      background: #8B4513;
      color: white;
    }
    .time-option.unavailable {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f8f9fa;
    }
    
    /* å—å–æ™‚é–“å¸¯ã®èª¬æ˜ */
    .time-info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 1rem;
      border-radius: 0 8px 8px 0;
      margin-bottom: 1rem;
    }
    
    /* å•†å“ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
    @media (max-width: 768px) {
      .table-responsive {
        border: none;
        box-shadow: none;
      }
      .table th, .table td {
        padding: 0.5rem 0.3rem;
        font-size: 0.85rem;
      }
      .table th:first-child, .table td:first-child {
        width: 45%;
      }
      .table th:nth-child(2), .table td:nth-child(2) {
        width: 20%;
      }
      .table th:nth-child(3), .table td:nth-child(3) {
        width: 15%;
      }
      .table th:nth-child(4), .table td:nth-child(4) {
        width: 20%;
      }
      
      /* ãƒ¢ãƒã‚¤ãƒ«ç”¨æ™‚é–“é¸æŠ */
      .time-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.3rem;
      }
      .time-option {
        padding: 0.5rem 0.25rem;
        font-size: 0.8rem;
      }
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 300px;
      background: white;
      border-radius: 15px;
      margin: 1rem 0;
    }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
    .status-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(40, 167, 69, 0.9);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }
    
    /* åœ¨åº«ãƒãƒƒã‚¸ */
    .stock-ok { background-color: #28a745; }
    .stock-low { background-color: #ffc107; color: #000; }
    .stock-out { background-color: #dc3545; }
    .stock-updating { background-color: #6c757d; }
    
    /* æ•°é‡é¸æŠå™¨ã®ã‚¹ã‚¿ã‚¤ãƒ«æ”¹å–„ */
    .quantity-selector {
      display: flex;
      align-items: center;
      border: 2px solid #e8dcc6;
      border-radius: 8px;
      overflow: hidden;
      background: white;
    }
    .quantity-btn {
      border: none;
      background: #f8f9fa;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .quantity-btn:hover {
      background: #8B4513;
      color: white;
    }
    .quantity-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .quantity-input {
      border: none;
      width: 50px;
      text-align: center;
      font-weight: bold;
      background: transparent;
    }
    .quantity-input:focus {
      outline: none;
      box-shadow: none;
    }
    
    /* åœ¨åº«è­¦å‘Šè¡¨ç¤º */
    .stock-warning {
      display: none;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 0.5rem;
      border-radius: 4px;
      margin-top: 0.5rem;
      font-size: 0.8rem;
    }
    .stock-warning.show {
      display: block;
      animation: slideDown 0.3s ease;
    }
    
    /* åœ¨åº«ãƒã‚§ãƒƒã‚¯ä¸­è¡¨ç¤º */
    .checking-stock {
      opacity: 0.7;
      pointer-events: none;
    }
    
    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    .progress-indicator {
      margin-bottom: 2rem;
    }
    .progress-step {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .step {
      flex: 1;
      text-align: center;
      position: relative;
    }
    .step.active .step-circle {
      background: #8B4513;
      color: white;
    }
    .step.completed .step-circle {
      background: #28a745;
      color: white;
    }
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.5rem;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .step-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: #6c757d;
    }
    .step.active .step-label {
      color: #8B4513;
    }
    
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.05); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s cubic-bezier(.4,0,.2,1);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* åˆè¨ˆé‡‘é¡ã®å¼·èª¿ */
    .total-price {
      font-size: 1.5rem;
      font-weight: bold;
      color: #8B4513;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åˆ¥ã®æœ€é©åŒ– */
    .screen { display: none; }
    .screen.active { display: block; }
    
    /* ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .invalid-feedback {
      display: block;
      font-size: 0.875rem;
      color: #dc3545;
      margin-top: 0.25rem;
    }
    .valid-feedback {
      display: block;
      font-size: 0.875rem;
      color: #28a745;
      margin-top: 0.25rem;
    }
    
    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    .footer {
      color: #6b4423;
      font-size: 0.9rem;
      padding: 2rem 0;
      text-align: center;
      background: rgba(248, 243, 236, 0.8);
      margin-top: 2rem;
      border-radius: 15px;
    }
    
    /* å–¶æ¥­æ™‚é–“è¡¨ç¤º */
    .business-hours {
      background: #e8f5e8;
      border-left: 4px solid #28a745;
      padding: 1rem;
      border-radius: 0 8px 8px 0;
      margin-bottom: 1rem;
    }
    .business-hours h6 {
      color: #155724;
      margin-bottom: 0.5rem;
    }
    .business-hours p {
      color: #155724;
      margin-bottom: 0;
      font-size: 0.9rem;
    }
    
    /* ä»Šæ—¥ã®ç‰¹åˆ¥è¡¨ç¤º */
    .today-special {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      border: 2px solid #ffeb3b;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      text-align: center;
    }
    .today-special h5 {
      color: #856404;
      margin-bottom: 0.5rem;
    }
    .today-special p {
      color: #6c5617;
      margin-bottom: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div class="status-indicator pulse" id="status">
      <i class="bi bi-wifi"></i> æ¥ç¶šä¸­
    </div>
    
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header fade-in">
      <h1><i class="bi bi-shop me-2"></i>Hyggelyã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥å°‚é–€åº—</h1>
      <h2>ã”äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ  v5.3.2</h2>
      <p class="mt-3 mb-0"><i class="bi bi-clock me-2"></i>åœ¨åº«ã¯æ³¨æ–‡æ™‚ã«æœ€æ–°æƒ…å ±ã§ç¢ºèªã•ã‚Œã¾ã™</p>
    </div>
    
    <!-- å–¶æ¥­æ™‚é–“è¡¨ç¤º -->
    <div class="business-hours fade-in">
      <h6><i class="bi bi-clock me-2"></i>å–¶æ¥­æ™‚é–“ãƒ»å—å–æ™‚é–“</h6>
      <p>
        <strong>å–¶æ¥­æ—¥ï¼š</strong>æ°´æ›œæ—¥ãƒ»åœŸæ›œæ—¥<br>
        <strong>å–¶æ¥­æ™‚é–“ï¼š</strong>11:00-17:00<br>
        <strong>å—å–å¯èƒ½æ™‚é–“ï¼š</strong>11:00-17:00ï¼ˆ15åˆ†é–“éš”ã§ã”æŒ‡å®šã„ãŸã ã‘ã¾ã™ï¼‰
      </p>
    </div>
    
    <!-- æœ¬æ—¥ã®ç‰¹åˆ¥æ¡ˆå†… -->
    <div class="today-special fade-in">
      <h5><i class="bi bi-star-fill me-2"></i>æœ¬æ—¥ã®ãŠã™ã™ã‚</h5>
      <p>å¿ƒã‚’è¾¼ã‚ã¦ç„¼ãä¸Šã’ãŸã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥ã‚’ã€ãœã²ã”è³å‘³ãã ã•ã„ã€‚äº‹å‰äºˆç´„ã§ç¢ºå®Ÿã«ãŠå—ã‘å–ã‚Šã„ãŸã ã‘ã¾ã™ã€‚</p>
    </div>
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loading-screen" class="screen active">
      <div class="loading">
        <div class="spinner-border" style="width: 3rem; height: 3rem; color: #8B4513;"></div>
        <p class="mt-3" style="font-weight: 600; color: #8B4513;"><i class="bi bi-box-seam me-2"></i>å•†å“æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        <div class="progress mt-3" style="width: 200px;">
          <div class="progress-bar bg-warning" id="loading-progress" style="width: 0%"></div>
        </div>
      </div>
    </div>
    
    <!-- æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ç”»é¢ -->
    <div id="form-screen" class="screen">
      <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º -->
      <div class="progress-indicator">
        <div class="progress-step">
          <div class="step active" data-step="1">
            <div class="step-circle">1</div>
            <div class="step-label">ãŠå®¢æ§˜æƒ…å ±</div>
          </div>
          <div class="step" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-label">å•†å“é¸æŠ</div>
          </div>
          <div class="step" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-label">ç¢ºèª</div>
          </div>
          <div class="step" data-step="4">
            <div class="step-circle">4</div>
            <div class="step-label">å®Œäº†</div>
          </div>
        </div>
        <div class="progress">
          <div class="progress-bar" id="form-progress" style="width: 25%"></div>
        </div>
      </div>
      
      <div class="card fade-in">
        <div class="card-header">
          <h3 class="mb-0"><i class="bi bi-person-fill me-2"></i>ãŠå®¢æ§˜æƒ…å ±ãƒ»å•†å“é¸æŠ</h3>
        </div>
        <div class="card-body">
          <form id="order-form" novalidate>
            <!-- ãŠå®¢æ§˜æƒ…å ± -->
            <div id="customer-info-section">
              <h5 class="mb-3"><i class="bi bi-person-badge me-2"></i>ãŠå®¢æ§˜æƒ…å ±</h5>
              <div class="row mb-3">
                <div class="col-md-6 mb-3">
                  <label for="lastName" class="form-label"><i class="bi bi-person me-1"></i>æ°åï¼ˆå§“ï¼‰<span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="lastName" name="lastName" required placeholder="ä¾‹ï¼šå±±ç”°" autocomplete="family-name">
                  <div class="invalid-feedback">å§“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                  <div class="valid-feedback">æ­£ã—ãå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã™</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="firstName" class="form-label"><i class="bi bi-person me-1"></i>æ°åï¼ˆåï¼‰<span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="firstName" name="firstName" required placeholder="ä¾‹ï¼šå¤ªéƒ" autocomplete="given-name">
                  <div class="invalid-feedback">åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                  <div class="valid-feedback">æ­£ã—ãå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã™</div>
                </div>
              </div>
              <div class="mb-3">
                <label for="email" class="form-label"><i class="bi bi-envelope me-1"></i>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹<span class="text-danger">*</span></label>
                <input type="email" class="form-control" id="email" name="email" required placeholder="ä¾‹ï¼štaro.yamada@email.com" autocomplete="email">
                <div class="invalid-feedback">æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                <div class="valid-feedback">æ­£ã—ãå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã™</div>
                <div class="form-text">ç¢ºèªãƒ¡ãƒ¼ãƒ«ãŒã“ã¡ã‚‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€ä¿¡ã•ã‚Œã¾ã™</div>
              </div>
              <div class="row mb-4">
                <div class="col-md-6 mb-3">
                  <label for="pickupDate" class="form-label"><i class="bi bi-calendar-event me-1"></i>å—å–æ—¥ï¼ˆæ°´ãƒ»åœŸã®ã¿ï¼‰<span class="text-danger">*</span></label>
                  <select class="form-select" id="pickupDate" name="pickupDate" required>
                    <option value="">å—å–æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                  </select>
                  <div class="invalid-feedback">å—å–æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                  <div class="valid-feedback">æ­£ã—ãé¸æŠã•ã‚Œã¦ã„ã¾ã™</div>
                </div>
                <!-- å—å–æ™‚é–“é¸æŠã®æ”¹å–„ -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><i class="bi bi-clock me-1"></i>å—å–æ™‚é–“ï¼ˆ11:00-17:00ï¼‰<span class="text-danger">*</span></label>
                  <input type="hidden" id="pickupTime" name="pickupTime" required>
                  <div class="time-info">
                    <small><i class="bi bi-info-circle me-1"></i>15åˆ†é–“éš”ã§ãŠé¸ã³ã„ãŸã ã‘ã¾ã™ã€‚æ··é›‘çŠ¶æ³ã«ã‚ˆã‚Šå‰å¾Œã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</small>
                  </div>
                  <div class="time-grid" id="time-options">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                  </div>
                  <div class="invalid-feedback" id="time-feedback">å—å–æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                  <div class="valid-feedback" id="time-valid-feedback">æ­£ã—ãé¸æŠã•ã‚Œã¦ã„ã¾ã™</div>
                </div>
              </div>
              
              <button type="button" class="btn btn-primary" id="next-to-products">
                å•†å“é¸æŠã«é€²ã‚€ <i class="bi bi-arrow-right ms-2"></i>
              </button>
            </div>
            
            <!-- å•†å“é¸æŠ -->
            <div id="product-selection-section" style="display: none;">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-basket me-2"></i>å•†å“é¸æŠ</h5>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="back-to-customer-info">
                  <i class="bi bi-arrow-left me-1"></i>æˆ»ã‚‹
                </button>
              </div>
              
              <!-- åœ¨åº«çŠ¶æ³ã‚¢ãƒ©ãƒ¼ãƒˆ -->
              <div id="stock-alert" class="alert alert-info" style="display: none;">
                <i class="bi bi-info-circle me-2"></i>
                <span id="stock-alert-message"></span>
              </div>
              
              <!-- å•†å“ä¸€è¦§ -->
              <div class="table-responsive">
                <table class="table table-hover" id="products-table">
                  <thead>
                    <tr>
                      <th>å•†å“åï¼ˆåœ¨åº«ï¼‰</th>
                      <th>å˜ä¾¡</th>
                      <th>æ•°é‡</th>
                      <th>å°è¨ˆ</th>
                    </tr>
                  </thead>
                  <tbody id="products-list">
                    <!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³è¡¨ç¤ºï¼ˆåˆæœŸè¡¨ç¤ºæ™‚ã®ã¿ï¼‰ -->
                    <tr class="skeleton-row">
                      <td colspan="4">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-badge"></div>
                      </td>
                    </tr>
                    <tr class="skeleton-row">
                      <td colspan="4">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-badge"></div>
                      </td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr class="table-warning">
                      <th colspan="3" class="text-end fs-5">åˆè¨ˆ</th>
                      <th><span id="total-price" class="total-price">Â¥0</span></th>
                    </tr>
                  </tfoot>
                </table>
              </div>
              
              <!-- é¸æŠæ¸ˆã¿å•†å“ã‚µãƒãƒªãƒ¼ -->
              <div id="selected-summary" class="mt-3" style="display: none;">
                <div class="alert alert-success">
                  <h6><i class="bi bi-check-circle me-2"></i>é¸æŠæ¸ˆã¿å•†å“</h6>
                  <div id="selected-items"></div>
                </div>
              </div>
              
              <!-- å‚™è€ƒ -->
              <div class="mb-3">
                <label for="note" class="form-label"><i class="bi bi-chat-text me-1"></i>ãã®ä»–ã”è¦æœ›</label>
                <textarea class="form-control" id="note" name="note" rows="3" placeholder="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚„ã”è¦æœ›ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã”è¨˜å…¥ãã ã•ã„ï¼ˆä»»æ„ï¼‰"></textarea>
                <div class="form-text">
                  <i class="bi bi-info-circle me-1"></i>
                  ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±ï¼šå•†å“ã«ã¯å°éº¦ã€åµã€ä¹³è£½å“ã€ãƒŠãƒƒãƒ„é¡ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
                </div>
              </div>
              
              <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
              <div class="d-grid mt-4">
                <button type="button" class="btn btn-primary btn-lg" id="confirm-button" disabled>
                  <i class="bi bi-check-circle me-2"></i>äºˆç´„å†…å®¹ç¢ºèª
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- ç¢ºèªç”»é¢ -->
    <div id="confirm-screen" class="screen">
      <div class="card fade-in">
        <div class="card-header" style="background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);">
          <h3 class="mb-0"><i class="bi bi-check-circle me-2"></i>äºˆç´„å†…å®¹ç¢ºèª</h3>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            å†…å®¹ã‚’ã”ç¢ºèªã®ä¸Šã€é–“é•ã„ãŒãªã‘ã‚Œã°ã€Œã“ã®å†…å®¹ã§äºˆç´„ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
          </div>
          
          <div class="row mb-4">
            <div class="col-md-6 mb-3">
              <h5><i class="bi bi-person-badge me-2"></i>ãŠå®¢æ§˜æƒ…å ±</h5>
              <dl class="row">
                <dt class="col-4">ãŠåå‰</dt>
                <dd class="col-8" id="confirm-name"></dd>
                <dt class="col-4">ãƒ¡ãƒ¼ãƒ«</dt>
                <dd class="col-8" id="confirm-email"></dd>
                <dt class="col-4">å—å–æ—¥æ™‚</dt>
                <dd class="col-8" id="confirm-pickup"></dd>
              </dl>
            </div>
            <div class="col-md-6">
              <h5><i class="bi bi-basket me-2"></i>æ³¨æ–‡å†…å®¹</h5>
              <div id="confirm-items"></div>
              <div class="mt-3 pt-3 border-top">
                <strong class="total-price">åˆè¨ˆ: <span id="confirm-total">Â¥0</span></strong>
              </div>
            </div>
          </div>
          
          <div id="confirm-note-section" class="mb-4" style="display:none;">
            <h5><i class="bi bi-chat-text me-2"></i>ãã®ä»–ã”è¦æœ›</h5>
            <p id="confirm-note" class="p-3 bg-light rounded"></p>
          </div>
          
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>ãŠæ”¯æ‰•ã„ã«ã¤ã„ã¦</strong><br>
            å½“æ—¥ã€å•†å“ãŠå—ã‘å–ã‚Šæ™‚ã«ç¾é‡‘ã¾ãŸã¯PayPayã§ãŠæ”¯æ‰•ã„ãã ã•ã„ã€‚
          </div>
          
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" id="back-button">
              <i class="bi bi-arrow-left me-1"></i>æˆ»ã‚‹
            </button>
            <button type="button" class="btn btn-success btn-lg" id="submit-button">
              <i class="bi bi-check2-circle me-2"></i>ã“ã®å†…å®¹ã§äºˆç´„ã™ã‚‹
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å®Œäº†ç”»é¢ -->
    <div id="success-screen" class="screen">
      <div class="card fade-in">
        <div class="card-header" style="background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);">
          <h3 class="mb-0"><i class="bi bi-check-circle-fill me-2"></i>äºˆç´„å®Œäº†</h3>
        </div>
        <div class="card-body text-center">
          <div class="mb-4">
            <i class="bi bi-check-circle-fill" style="font-size: 5rem; color: #28a745;"></i>
          </div>
          <h4 class="mb-3">ğŸ‰ ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸ‰</h4>
          <p id="success-message" class="mb-4"></p>
          
          <div id="success-details" class="mb-4"></div>
          
          <div class="alert alert-info">
            <h6><i class="bi bi-envelope me-2"></i>ç¢ºèªãƒ¡ãƒ¼ãƒ«ã«ã¤ã„ã¦</h6>
            <p class="mb-0">
              ã”ç™»éŒ²ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ãŠé€ã‚Šã—ã¾ã—ãŸã€‚<br>
              ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„å ´åˆã¯ã€è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚‚ã”ç¢ºèªãã ã•ã„ã€‚
            </p>
          </div>
          
          <div class="alert alert-success">
            <h6><i class="bi bi-calendar-check me-2"></i>å—å–ã«ã¤ã„ã¦</h6>
            <p class="mb-0">
              <strong>å—å–æ—¥å½“æ—¥ã¯ã€æŒ‡å®šã®ãŠæ™‚é–“ï¼ˆ11:00-17:00å†…ï¼‰ã«ãŠè¶Šã—ãã ã•ã„ã€‚</strong><br>
              ãŠæ”¯æ‰•ã„ã¯ç¾é‡‘ã¾ãŸã¯PayPayã§æ‰¿ã‚Šã¾ã™ã€‚<br>
              <small class="text-muted">â€»æ™‚é–“ã¯å¤šå°‘å‰å¾Œã™ã‚‹å ´åˆãŒã”ã–ã„ã¾ã™</small>
            </p>
          </div>
          
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary btn-lg" id="new-order-button">
              <i class="bi bi-plus-circle me-2"></i>æ–°ã—ã„äºˆç´„ã‚’ã™ã‚‹
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
              <i class="bi bi-printer me-2"></i>ã“ã®ç”»é¢ã‚’å°åˆ·
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ã‚¨ãƒ©ãƒ¼ç”»é¢ -->
    <div id="error-screen" class="screen">
      <div class="card fade-in">
        <div class="card-header" style="background: linear-gradient(135deg, #dc3545 0%, #e55565 100%);">
          <h3 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
        </div>
        <div class="card-body text-center">
          <div class="mb-4">
            <i class="bi bi-exclamation-triangle-fill" style="font-size: 5rem; color: #dc3545;"></i>
          </div>
          <p id="error-message" class="mb-4"></p>
          
          <div class="alert alert-warning">
            <h6><i class="bi bi-lightbulb me-2"></i>è§£æ±ºæ–¹æ³•</h6>
            <ul class="text-start mb-0">
              <li>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã¿ã¦ãã ã•ã„</li>
              <li>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„</li>
              <li>ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„</li>
              <li>å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆã¯ã€ãŠæ‰‹æ•°ã§ã™ãŒç›´æ¥ãŠé›»è©±ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„</li>
            </ul>
          </div>
          
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary btn-lg" id="retry-button">
              <i class="bi bi-arrow-clockwise me-2"></i>ã‚„ã‚Šç›´ã™
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="location.reload()">
              <i class="bi bi-bootstrap-reboot me-2"></i>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <div class="footer">
      <p>&copy; <script>document.write(new Date().getFullYear())</script> Hyggelyã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥å°‚é–€åº—</p>
      <p>å¿ƒã‚’è¾¼ã‚ã¦æ‰‹ä½œã‚Šã™ã‚‹ã“ã ã‚ã‚Šã®ãƒ‘ãƒ³ã‚’ãŠå±Šã‘ã—ã¾ã™</p>
      <p><small>ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„</small></p>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆv5.3.2å¯¾å¿œï¼‰
    let inventoryData = [];
    let totalPrice = 0;
    let isSubmitting = false;
    let currentStep = 1;
    let selectedProducts = new Map();
    let stockCheckTimeout = null;
    let lastStockCheckTime = 0;
    let selectedTimeSlot = null;

    // å—å–æ™‚é–“ç”Ÿæˆï¼ˆ11:00-17:00ã€15åˆ†é–“éš”ï¼‰
    const pickupTimeSlots = generateTimeSlots();

    function generateTimeSlots() {
      const slots = [];
      const startHour = 11;
      const endHour = 17;
      
      for (let hour = startHour; hour <= endHour; hour++) {
        for (let minute = 0; minute < 60; minute += 15) {
          // 17:00ã¾ã§ãªã®ã§ã€17:15ä»¥é™ã¯é™¤å¤–
          if (hour === 17 && minute > 0) break;
          
          const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          slots.push({
            value: timeString,
            label: timeString,
            available: true
          });
        }
      }
      
      return slots;
    }

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ Hyggelyã‚·ã‚¹ãƒ†ãƒ èµ·å‹• v5.3.2 - ä¿®æ­£ç‰ˆ');
      
      generatePickupDates();
      generateTimeOptions();
      loadInventoryData();
      setupEventListeners();
      updateStatus('æ¥ç¶šå®Œäº†', 'success');
      animateLoading();
    });

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    function animateLoading() {
      let progress = 0;
      const progressBar = document.getElementById('loading-progress');
      const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 90) {
          progress = 90;
          clearInterval(interval);
        }
        progressBar.style.width = progress + '%';
      }, 100);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ã‚¹ãƒ†ãƒƒãƒ—é·ç§»
      document.getElementById('next-to-products').addEventListener('click', showProductSelection);
      document.getElementById('back-to-customer-info').addEventListener('click', showCustomerInfo);
      document.getElementById('confirm-button').addEventListener('click', showConfirmation);
      document.getElementById('back-button').addEventListener('click', showFormScreen);
      document.getElementById('submit-button').addEventListener('click', submitOrder);
      document.getElementById('new-order-button').addEventListener('click', resetForm);
      document.getElementById('retry-button').addEventListener('click', () => {
        showLoadingScreen();
        loadInventoryData();
      });

      // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const form = document.getElementById('order-form');
      form.addEventListener('input', validateFormRealTime);
      form.addEventListener('change', validateFormRealTime);
    }

    // æ™‚é–“é¸æŠè‚¢ç”Ÿæˆ
    function generateTimeOptions() {
      const container = document.getElementById('time-options');
      
      pickupTimeSlots.forEach(slot => {
        const timeOption = document.createElement('div');
        timeOption.className = 'time-option';
        timeOption.dataset.time = slot.value;
        timeOption.textContent = slot.label;
        
        timeOption.addEventListener('click', function() {
          selectTimeSlot(slot.value);
        });
        
        container.appendChild(timeOption);
      });
    }

    // æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆé¸æŠ
    function selectTimeSlot(timeValue) {
      // æ—¢å­˜ã®é¸æŠã‚’è§£é™¤
      document.querySelectorAll('.time-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      // æ–°ã—ã„é¸æŠã‚’é©ç”¨
      const selectedOption = document.querySelector(`[data-time="${timeValue}"]`);
      if (selectedOption) {
        selectedOption.classList.add('selected');
        selectedTimeSlot = timeValue;
        
        // hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
        document.getElementById('pickupTime').value = timeValue;
        
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
        const hiddenInput = document.getElementById('pickupTime');
        hiddenInput.classList.remove('is-invalid');
        hiddenInput.classList.add('is-valid');
        
        document.getElementById('time-feedback').style.display = 'none';
        document.getElementById('time-valid-feedback').style.display = 'block';
        
        console.log('ğŸ• å—å–æ™‚é–“é¸æŠ:', timeValue);
      }
    }

    // å—å–æ—¥é¸æŠè‚¢ç”Ÿæˆï¼ˆæ°´ãƒ»åœŸã®ã¿ï¼‰
    function generatePickupDates() {
      const select = document.getElementById('pickupDate');
      const today = new Date();
      const currentHour = today.getHours();
      
      for (let i = 0; i <= 30; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        const dayOfWeek = date.getDay();
        
        if (dayOfWeek === 3 || dayOfWeek === 6) { // æ°´æ›œæ—¥ã¾ãŸã¯åœŸæ›œæ—¥
          if (i === 0 && currentHour >= 9) continue; // å½“æ—¥9æ™‚ä»¥é™ã¯é™¤å¤–
          
          const option = document.createElement('option');
          option.value = formatDate(date);
          option.textContent = formatDisplayDate(date) + (dayOfWeek === 3 ? 'ï¼ˆæ°´ï¼‰' : 'ï¼ˆåœŸï¼‰') + (i === 0 ? ' [æœ¬æ—¥]' : '');
          select.appendChild(option);
        }
      }
    }

    // åœ¨åº«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadInventoryData() {
      updateStatus('å•†å“æƒ…å ±èª­ã¿è¾¼ã¿ä¸­', 'loading');
      
      google.script.run
        .withSuccessHandler(function(products) {
          inventoryData = products || [];
          renderProductList();
          updateTotalPrice();
          finishLoading();
          updateStatus('èª­ã¿è¾¼ã¿å®Œäº†', 'success');
        })
        .withFailureHandler(function(error) {
          console.error('åœ¨åº«ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          showErrorScreen('å•†å“æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
          updateStatus('æ¥ç¶šã‚¨ãƒ©ãƒ¼', 'error');
        })
        .getInventoryDataForForm();
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†
    function finishLoading() {
      const progressBar = document.getElementById('loading-progress');
      progressBar.style.width = '100%';
      setTimeout(() => {
        showFormScreen();
        updateStep(1);
      }, 500);
    }

    // å•†å“ãƒªã‚¹ãƒˆè¡¨ç¤º
    function renderProductList() {
      const tbody = document.getElementById('products-list');
      tbody.innerHTML = '';
      
      inventoryData.forEach((product, index) => {
        const row = document.createElement('tr');
        let stockBadge = '';
        let rowStyle = '';
        if (product.remaining <= 0) {
          stockBadge = '<span class="badge stock-out">åœ¨åº«ãªã—</span>';
          rowStyle = 'opacity: 0.5;';
        } else if (product.remaining <= 2) {
          stockBadge = `<span class="badge stock-low">æ®‹ã‚Š${product.remaining}å€‹</span>`;
        } else {
          stockBadge = `<span class="badge stock-ok">æ®‹ã‚Š${product.remaining}å€‹</span>`;
        }
        row.style.cssText = rowStyle;
        row.classList.add('product-row');
        row.dataset.productId = product.id;
        
        row.innerHTML = `
          <td>
            <div class="d-flex align-items-center">
              <div>
                <strong>${product.name || ''}</strong><br>
                ${stockBadge}
              </div>
            </div>
          </td>
          <td><strong>Â¥${product.price.toLocaleString()}</strong></td>
          <td>
            <div class="quantity-selector">
              <button type="button" class="quantity-btn" onclick="decreaseQuantity(${index})" ${product.remaining <= 0 ? 'disabled' : ''}>
                <i class="bi bi-dash"></i>
              </button>
              <input type="number" class="quantity-input" id="product_${index}" name="product_${index}" 
                     value="0" min="0" max="${Math.min(product.remaining, 10)}" 
                     ${product.remaining <= 0 ? 'disabled' : ''} 
                     onchange="handleQuantityChange(${index}, this.value)">
              <button type="button" class="quantity-btn" onclick="increaseQuantity(${index})" ${product.remaining <= 0 ? 'disabled' : ''}>
                <i class="bi bi-plus"></i>
              </button>
            </div>
            <div class="stock-warning" id="warning_${index}"></div>
          </td>
          <td><span id="subtotal_${index}" class="fw-bold text-primary">Â¥0</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    // æ•°é‡å¤‰æ›´æ™‚ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    function handleQuantityChange(index, value) {
      const qty = parseInt(value) || 0;
      const product = inventoryData[index];
      
      if (qty > Math.min(product.remaining, 10)) {
        document.getElementById(`product_${index}`).value = Math.min(product.remaining, 10);
        return;
      }
      
      updateQuantity(index, qty);
    }

    // æ•°é‡æ“ä½œ
    function increaseQuantity(index) {
      const input = document.getElementById(`product_${index}`);
      const currentValue = parseInt(input.value) || 0;
      const maxValue = parseInt(input.max) || 0;
      
      if (currentValue < maxValue) {
        input.value = currentValue + 1;
        handleQuantityChange(index, input.value);
      }
    }

    function decreaseQuantity(index) {
      const input = document.getElementById(`product_${index}`);
      const currentValue = parseInt(input.value) || 0;
      
      if (currentValue > 0) {
        input.value = currentValue - 1;
        handleQuantityChange(index, input.value);
      }
    }

    function updateQuantity(index, value) {
      const qty = parseInt(value) || 0;
      const product = inventoryData[index];
      
      updateSubtotal(index, qty);
      updateTotalPrice();
      updateSelectedProducts();
      updateConfirmButton();
      
      const row = document.querySelector(`[data-product-id="${product.id}"]`);
      if (qty > 0) {
        row.classList.add('selected');
      } else {
        row.classList.remove('selected');
      }
    }

    // å°è¨ˆæ›´æ–°
    function updateSubtotal(index, quantity) {
      const qty = parseInt(quantity) || 0;
      const product = inventoryData[index];
      const subtotal = product.price * qty;
      
      const subtotalElement = document.getElementById(`subtotal_${index}`);
      if (subtotalElement) {
        subtotalElement.textContent = `Â¥${subtotal.toLocaleString()}`;
      }
    }

    // åˆè¨ˆé‡‘é¡æ›´æ–°
    function updateTotalPrice() {
      let newTotal = 0;
      
      inventoryData.forEach((product, index) => {
        const input = document.getElementById(`product_${index}`);
        if (input && !input.disabled) {
          const quantity = parseInt(input.value) || 0;
          newTotal += product.price * quantity;
        }
      });
      
      totalPrice = newTotal;
      const totalElement = document.getElementById('total-price');
      if (totalElement) {
        totalElement.textContent = `Â¥${totalPrice.toLocaleString()}`;
      }
      
      const progressBar = document.getElementById('form-progress');
      if (totalPrice > 0) {
        progressBar.classList.add('bg-success');
        progressBar.classList.remove('bg-primary');
      } else {
        progressBar.classList.add('bg-primary');
        progressBar.classList.remove('bg-success');
      }
    }

    // é¸æŠå•†å“æ›´æ–°
    function updateSelectedProducts() {
      selectedProducts.clear();
      
      inventoryData.forEach((product, index) => {
        const input = document.getElementById(`product_${index}`);
        const quantity = parseInt(input?.value || 0);
        
        if (quantity > 0) {
          selectedProducts.set(product.id, {
            name: product.name,
            price: product.price,
            quantity: quantity,
            subtotal: product.price * quantity
          });
        }
      });
      
      updateSelectedSummary();
    }

    // é¸æŠæ¸ˆã¿å•†å“ã‚µãƒãƒªãƒ¼æ›´æ–°
    function updateSelectedSummary() {
      const summary = document.getElementById('selected-summary');
      const itemsDiv = document.getElementById('selected-items');
      if (selectedProducts.size > 0) {
        let html = '';
        selectedProducts.forEach(item => {
          html += `<span class="badge bg-primary me-2 mb-1">${item.name} Ã—${item.quantity}</span>`;
        });
        itemsDiv.innerHTML = html;
        summary.style.display = 'block';
      } else {
        summary.style.display = 'none';
      }
    }

    // ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†
    function updateStep(step) {
      currentStep = step;
      
      document.querySelectorAll('.step').forEach((stepEl, index) => {
        stepEl.classList.remove('active', 'completed');
        if (index + 1 < step) {
          stepEl.classList.add('completed');
        } else if (index + 1 === step) {
          stepEl.classList.add('active');
        }
      });
      
      const progress = (step / 4) * 100;
      const progressBar = document.getElementById('form-progress');
      if (progressBar) {
        progressBar.style.width = progress + '%';
      }
    }

    function showCustomerInfo() {
      document.getElementById('customer-info-section').style.display = 'block';
      document.getElementById('product-selection-section').style.display = 'none';
      updateStep(1);
    }

    function showProductSelection() {
      if (!validateCustomerInfo()) {
        return;
      }
      
      document.getElementById('customer-info-section').style.display = 'none';
      document.getElementById('product-selection-section').style.display = 'block';
      updateStep(2);
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ™‚é–“é¸æŠå¯¾å¿œï¼‰
    function validateCustomerInfo() {
      const form = document.getElementById('order-form');
      const requiredFields = ['lastName', 'firstName', 'email', 'pickupDate'];
      let isValid = true;
      
      // åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      requiredFields.forEach(fieldName => {
        const field = form[fieldName];
        if (!field || !field.value.trim()) {
          if (field) {
            field.classList.add('is-invalid');
            field.classList.remove('is-valid');
          }
          isValid = false;
        } else {
          field.classList.remove('is-invalid');
          field.classList.add('is-valid');
        }
      });
      
      // æ™‚é–“é¸æŠã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const pickupTimeField = document.getElementById('pickupTime');
      if (!selectedTimeSlot || !pickupTimeField.value) {
        document.getElementById('time-feedback').style.display = 'block';
        document.getElementById('time-valid-feedback').style.display = 'none';
        isValid = false;
      } else {
        document.getElementById('time-feedback').style.display = 'none';
        document.getElementById('time-valid-feedback').style.display = 'block';
      }
      
      // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ãƒã‚§ãƒƒã‚¯
      const email = form.email;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (email && email.value && !emailRegex.test(email.value)) {
        email.classList.add('is-invalid');
        email.classList.remove('is-valid');
        isValid = false;
      }
      
      if (!isValid) {
        showToast('å¿…é ˆé …ç›®ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
      }
      
      return isValid;
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateFormRealTime() {
      const form = document.getElementById('order-form');
      const inputs = form.querySelectorAll('input[required], select[required]');
      
      inputs.forEach(input => {
        if (input.value.trim()) {
          input.classList.remove('is-invalid');
          input.classList.add('is-valid');
        } else {
          input.classList.remove('is-valid');
        }
      });
      
      updateConfirmButton();
    }

    // å…¨ä½“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateFullForm() {
      console.log('ğŸ” ãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
      
      const customerInfoValid = validateCustomerInfo();
      console.log('é¡§å®¢æƒ…å ±ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³:', customerInfoValid);
      
      const hasSelectedProducts = selectedProducts.size > 0;
      console.log('é¸æŠå•†å“æ•°:', selectedProducts.size);
      console.log('å•†å“é¸æŠãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³:', hasSelectedProducts);
      
      const isValid = customerInfoValid && hasSelectedProducts;
      console.log('ç·åˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ:', isValid);
      
      return isValid;
    }

    function updateConfirmButton() {
      const button = document.getElementById('confirm-button');
      if (!button) return;
      
      const hasSelectedProducts = selectedProducts.size > 0;
      const isOnProductPage = document.getElementById('product-selection-section').style.display !== 'none';
      
      if (isOnProductPage) {
        button.disabled = !hasSelectedProducts;
        
        if (hasSelectedProducts) {
          button.innerHTML = `<i class="bi bi-check-circle me-2"></i>äºˆç´„å†…å®¹ç¢ºèªï¼ˆ${selectedProducts.size}å•†å“ï¼‰`;
        } else {
          button.innerHTML = '<i class="bi bi-check-circle me-2"></i>å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„';
        }
      }
    }

    // ç¢ºèªç”»é¢è¡¨ç¤º
    function showConfirmation() {
      console.log('ğŸ”„ ç¢ºèªç”»é¢è¡¨ç¤ºå‡¦ç†é–‹å§‹');
      
      if (!validateFullForm()) {
        const errorMessages = [];
        
        if (!validateCustomerInfo()) {
          errorMessages.push('ãŠå®¢æ§˜æƒ…å ±ã«ä¸å‚™ãŒã‚ã‚Šã¾ã™');
        }
        
        if (selectedProducts.size === 0) {
          errorMessages.push('å•†å“ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
        }
        
        showToast('å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:\n' + errorMessages.join('\n'), 'error');
        return;
      }
      
      updateStatus('æœ€çµ‚åœ¨åº«ç¢ºèªä¸­', 'loading');
      
      google.script.run
        .withSuccessHandler(function(latestInventory) {
          const stockErrors = [];
          const currentSelections = saveCurrentSelections();
          
          Object.keys(currentSelections).forEach(productId => {
            const latestProduct = latestInventory.find(p => p.id === productId);
            const requestedQuantity = currentSelections[productId];
            
            if (!latestProduct || latestProduct.remaining < requestedQuantity) {
              const productName = inventoryData.find(p => p.id === productId)?.name || 'unknown';
              stockErrors.push({
                name: productName,
                requested: requestedQuantity,
                available: latestProduct ? latestProduct.remaining : 0
              });
            }
          });
          
          if (stockErrors.length > 0) {
            let errorMessage = 'ä»¥ä¸‹ã®å•†å“ã§åœ¨åº«ä¸è¶³ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ï¼š\n\n';
            stockErrors.forEach(error => {
              errorMessage += `â€¢ ${error.name}: ${error.requested}å€‹ â†’ ${error.available}å€‹ã«å¤‰æ›´\n`;
            });
            errorMessage += '\næ•°é‡ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚';
            
            showToast(errorMessage, 'error');
            updateStatus('åœ¨åº«ä¸è¶³', 'error');
            
            inventoryData = latestInventory;
            renderProductList();
            
            return;
          }
          
          proceedToConfirmation();
          updateStatus('ç¢ºèªç”»é¢è¡¨ç¤º', 'success');
        })
        .withFailureHandler(function(error) {
          console.error('æœ€çµ‚åœ¨åº«ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
          showToast('åœ¨åº«ç¢ºèªã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
          updateStatus('åœ¨åº«ç¢ºèªã‚¨ãƒ©ãƒ¼', 'error');
        })
        .getInventoryDataForForm();
    }

    // ç¾åœ¨ã®é¸æŠçŠ¶æ…‹ã‚’ä¿å­˜
    function saveCurrentSelections() {
      const selections = {};
      
      inventoryData.forEach((product, index) => {
        const input = document.getElementById(`product_${index}`);
        if (input) {
          const quantity = parseInt(input.value) || 0;
          if (quantity > 0) {
            selections[product.id] = quantity;
          }
        }
      });
      
      return selections;
    }

    // ç¢ºèªç”»é¢è¡¨ç¤ºï¼ˆåœ¨åº«ãƒã‚§ãƒƒã‚¯å¾Œï¼‰
    function proceedToConfirmation() {
      const form = document.getElementById('order-form');
      const formData = new FormData(form);
      
      // ãŠå®¢æ§˜æƒ…å ±
      document.getElementById('confirm-name').textContent = `${formData.get('lastName')} ${formData.get('firstName')}`;
      document.getElementById('confirm-email').textContent = formData.get('email');
      document.getElementById('confirm-pickup').textContent = `${formatDisplayDate(new Date(formData.get('pickupDate')))} ${selectedTimeSlot || formData.get('pickupTime')}`;
      
      // æ³¨æ–‡å†…å®¹
      let itemsHtml = '<div class="list-group list-group-flush">';
      selectedProducts.forEach(item => {
        itemsHtml += `
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>${item.name}</strong><br>
              <small class="text-muted">Â¥${item.price.toLocaleString()} Ã— ${item.quantity}</small>
            </div>
            <strong>Â¥${item.subtotal.toLocaleString()}</strong>
          </div>
        `;
      });
      itemsHtml += '</div>';
      
      document.getElementById('confirm-items').innerHTML = itemsHtml;
      document.getElementById('confirm-total').textContent = `Â¥${totalPrice.toLocaleString()}`;
      
      // å‚™è€ƒ
      const note = formData.get('note');
      if (note) {
        document.getElementById('confirm-note').textContent = note;
        document.getElementById('confirm-note-section').style.display = 'block';
      } else {
        document.getElementById('confirm-note-section').style.display = 'none';
      }
      
      showConfirmScreen();
      updateStep(3);
    }

    // æ³¨æ–‡é€ä¿¡
    function submitOrder() {
      if (isSubmitting) return;
      
      isSubmitting = true;
      const button = document.getElementById('submit-button');
      button.disabled = true;
      button.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>é€ä¿¡ä¸­...';
      updateStatus('é€ä¿¡ä¸­', 'loading');
      
      const formData = collectFormData();
      
      google.script.run
        .withSuccessHandler(function(result) {
          isSubmitting = false;
          if (result && result.success) {
            showSuccessScreen(result);
            updateStatus('äºˆç´„å®Œäº†', 'success');
            updateStep(4);
          } else {
            showErrorScreen(result ? result.message : 'äºˆç´„ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
            updateStatus('é€ä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
          }
        })
        .withFailureHandler(function(error) {
          isSubmitting = false;
          showErrorScreen('äºˆç´„ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
          updateStatus('é€ä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
        })
        .processOrder(formData);
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
    function collectFormData() {
      const form = document.getElementById('order-form');
      const formData = new FormData(form);
      const data = {};
      
      // åŸºæœ¬æƒ…å ±
      for (let [key, value] of formData.entries()) {
        data[key] = value;
      }
      
      // é¸æŠã•ã‚ŒãŸæ™‚é–“ã‚’ç¢ºå®Ÿã«è¨­å®š
      if (selectedTimeSlot) {
        data.pickupTime = selectedTimeSlot;
      }
      
      // å•†å“æ•°é‡
      inventoryData.forEach((product, index) => {
        const input = document.getElementById(`product_${index}`);
        data[`product_${index}`] = parseInt(input?.value || 0);
      });
      
      return data;
    }

    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
      });
      document.getElementById(screenId).classList.add('active');
      window.scrollTo(0, 0);
    }

    function showLoadingScreen() { showScreen('loading-screen'); }
    function showFormScreen() { showScreen('form-screen'); }
    function showConfirmScreen() { showScreen('confirm-screen'); }
    
    function showSuccessScreen(result) {
      document.getElementById('success-message').textContent = result.message;
      
      if (result.orderDetails) {
        const details = result.orderDetails;
        let detailsHtml = `
          <div class="card">
            <div class="card-header bg-success text-white">
              <h6 class="mb-0"><i class="bi bi-receipt me-2"></i>äºˆç´„è©³ç´°</h6>
            </div>
            <div class="card-body">
              <dl class="row mb-0">
                <dt class="col-sm-4">äºˆç´„ID</dt>
                <dd class="col-sm-8"><code>${details.orderId || 'ORD' + Date.now()}</code></dd>
                <dt class="col-sm-4">ãŠåå‰</dt>
                <dd class="col-sm-8">${details.name}</dd>
                <dt class="col-sm-4">å—å–æ—¥æ™‚</dt>
                <dd class="col-sm-8">${details.pickupDate} ${details.pickupTime}</dd>
                <dt class="col-sm-4">åˆè¨ˆé‡‘é¡</dt>
                <dd class="col-sm-8"><strong>Â¥${details.totalPrice.toLocaleString()}</strong></dd>
              </dl>
            </div>
          </div>
        `;
        document.getElementById('success-details').innerHTML = detailsHtml;
      }
      
      showScreen('success-screen');
    }
    
    function showErrorScreen(message) {
      document.getElementById('error-message').textContent = message;
      showScreen('error-screen');
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    function resetForm() {
      document.getElementById('order-form').reset();
      selectedProducts.clear();
      totalPrice = 0;
      currentStep = 1;
      selectedTimeSlot = null;
      
      // æ™‚é–“é¸æŠã®è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('.time-option').forEach(option => {
        option.classList.remove('selected');
      });
      document.getElementById('pickupTime').value = '';
      
      updateTotalPrice();
      updateSelectedSummary();
      generatePickupDates();
      showCustomerInfo();
      loadInventoryData();
      updateStep(1);
      
      document.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
        el.classList.remove('is-valid', 'is-invalid');
      });
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateStatus(message, type) {
      const status = document.getElementById('status');
      if (!status) return;
      
      let icon = 'bi-wifi';
      let color = 'rgba(40, 167, 69, 0.9)';
      
      switch (type) {
        case 'loading':
          icon = 'bi-arrow-clockwise';
          color = 'rgba(255, 193, 7, 0.9)';
          break;
        case 'error':
          icon = 'bi-exclamation-triangle';
          color = 'rgba(220, 53, 69, 0.9)';
          break;
        case 'success':
          icon = 'bi-check-circle';
          color = 'rgba(40, 167, 69, 0.9)';
          break;
      }
      
      status.innerHTML = `<i class="${icon}"></i> ${message}`;
      status.style.backgroundColor = color;
    }

    // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
      toast.style.cssText = 'position: fixed; top: 70px; right: 20px; z-index: 1100; min-width: 300px; white-space: pre-line;';
      toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, type === 'error' ? 8000 : 5000);
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function formatDate(date) {
      return date.getFullYear() + '-' +
             String(date.getMonth() + 1).padStart(2, '0') + '-' +
             String(date.getDate()).padStart(2, '0');
    }

    function formatDisplayDate(date) {
      return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
    }

    console.log('ğŸš€ Hyggelyã‚·ã‚¹ãƒ†ãƒ  v5.3.2 åˆæœŸåŒ–å®Œäº† - ä¿®æ­£ç‰ˆ');
  </script>
</body>
</html>