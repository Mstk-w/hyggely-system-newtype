<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hyggelyã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥å°‚é–€åº— ãƒ¡ãƒ¼ãƒ«è¨­å®š v5.2</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    body {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      min-height: 100vh;
    }
    
    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .navbar {
      background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%) !important;
      box-shadow: 0 4px 20px rgba(139, 69, 19, 0.3);
    }
    .navbar-brand { font-weight: bold; color: white !important; }
    .nav-link {
      color: rgba(255, 255, 255, 0.9) !important;
      transition: all 0.3s ease;
      border-radius: 6px;
      margin: 0 3px;
      padding: 8px 12px !important;
    }
    .nav-link:hover {
      color: white !important;
      background: rgba(255, 255, 255, 0.1);
    }
    
    /* ã‚«ãƒ¼ãƒ‰ */
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      margin-bottom: 1.5rem;
      background: rgba(255, 255, 255, 0.95);
      transition: all 0.3s ease;
    }
    .card:hover {
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    .card-header {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-bottom: 2px solid rgba(139, 69, 19, 0.1);
      font-weight: 700;
      padding: 1rem 1.5rem;
      border-radius: 12px 12px 0 0;
    }
    .card-body { padding: 1.5rem; }
    
    /* ãƒ•ã‚©ãƒ¼ãƒ  */
    .form-control, .form-select {
      border-radius: 8px;
      border: 2px solid #e9ecef;
      padding: 12px 16px;
      transition: all 0.3s ease;
    }
    .form-control:focus, .form-select:focus {
      border-color: #8B4513;
      box-shadow: 0 0 0 0.2rem rgba(139, 69, 19, 0.15);
    }
    .form-control:valid {
      border-color: #28a745;
    }
    .form-control:invalid {
      border-color: #dc3545;
    }
    
    /* ãƒœã‚¿ãƒ³ */
    .btn-primary {
      background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
      border: none;
      border-radius: 8px;
      font-weight: 600;
      padding: 12px 24px;
      transition: all 0.3s ease;
    }
    .btn-primary:hover { 
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(139, 69, 19, 0.3);
    }
    
    /* å¤‰æ•°ã‚¿ã‚° */
    .variable-tag {
      background: #8B4513;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      margin: 3px;
      display: inline-block;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    .variable-tag:hover {
      background: #a0522d;
      transform: scale(1.05);
      border-color: #8B4513;
    }
    .variable-tag.copied {
      background: #28a745;
      animation: pulse 0.5s ease;
    }
    
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
    .preview {
      background: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 1rem;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 400px;
      overflow-y: auto;
      position: relative;
    }
    .preview.email-preview {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 2px solid #8B4513;
    }
    .preview-header {
      background: #e9ecef;
      margin: -1.5rem -1.5rem 1rem -1.5rem;
      padding: 1rem 1.5rem;
      border-radius: 6px 6px 0 0;
      font-weight: bold;
      color: #495057;
    }
    
    /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç† */
    .template-selector {
      margin-bottom: 1rem;
    }
    .template-card {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .template-card:hover {
      border-color: #8B4513;
      background: rgba(139, 69, 19, 0.05);
    }
    .template-card.active {
      border-color: #8B4513;
      background: rgba(139, 69, 19, 0.1);
    }
    
    /* ã‚¿ãƒ– */
    .nav-tabs .nav-link {
      border-radius: 8px 8px 0 0;
      color: #6c757d;
      font-weight: 600;
    }
    .nav-tabs .nav-link.active {
      background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
      color: white;
      border-color: transparent;
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      display: none;
      text-align: center;
      padding: 3rem;
    }
    .loading.show { display: block; }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
    .status-indicator {
      position: fixed;
      top: 70px;
      right: 15px;
      z-index: 1000;
      background: rgba(40, 167, 69, 0.9);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.8rem;
    }
    
    /* çµ±è¨ˆè¡¨ç¤º */
    .email-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      border: 2px solid #e9ecef;
      text-align: center;
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      border-color: #8B4513;
      box-shadow: 0 4px 15px rgba(139, 69, 19, 0.1);
    }
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #8B4513;
    }
    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    
    /* æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ */
    .char-counter {
      position: absolute;
      bottom: 10px;
      right: 15px;
      font-size: 0.8rem;
      color: #6c757d;
      background: rgba(255, 255, 255, 0.9);
      padding: 2px 8px;
      border-radius: 4px;
    }
    .char-counter.warning {
      color: #ffc107;
    }
    .char-counter.danger {
      color: #dc3545;
    }
    
    /* ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ */
    .backup-section {
      background: #e3f2fd;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–æœ€é©åŒ– */
    @media (max-width: 768px) {
      .container-fluid { padding: 0.5rem; }
      .card { margin-bottom: 1rem; }
      .card-body { padding: 1rem; }
      .navbar-brand { font-size: 1rem; }
      .variable-tag {
        font-size: 0.7rem;
        padding: 4px 8px;
        margin: 2px;
      }
      .preview {
        font-size: 0.8rem;
        max-height: 250px;
      }
      .stat-number { font-size: 1.5rem; }
    }
    
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.05); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ */
    .theme-selector {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    /* ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆå¼·åŒ– */
    .help-text {
      background: #f8f9fa;
      border-left: 4px solid #8B4513;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 0 8px 8px 0;
    }

    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³å¼·åŒ– */
    .btn-preview {
      background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
      border: none;
      color: white;
    }
    .btn-preview:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
    }

    /* æˆåŠŸè¡¨ç¤ºã®å¼·åŒ– */
    .save-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      animation: saveSuccess 0.5s ease;
    }
    @keyframes saveSuccess {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
  <div class="status-indicator pulse" id="status">
    <i class="bi bi-wifi"></i> æ¥ç¶šä¸­
  </div>

  <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="bi bi-envelope-gear me-2"></i>Hyggelyãƒ¡ãƒ¼ãƒ«è¨­å®š v5.2
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="?action=dashboard&password=hyggelyAdmin2024" target="_blank">
            <i class="bi bi-speedometer2 me-1"></i>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
          </a>
          <a class="nav-link" href="?" target="_blank">
            <i class="bi bi-box-arrow-up-right me-1"></i>äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ 
          </a>
          <a class="nav-link" href="#" onclick="loadEmailSettings()">
            <i class="bi bi-arrow-clockwise me-1"></i>æ›´æ–°
          </a>
          <a class="nav-link" href="#" onclick="exportSettings()">
            <i class="bi bi-download me-1"></i>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-3">
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div class="loading" id="loading">
      <div class="spinner-border" style="color: #8B4513;"></div>
      <p class="mt-3">ãƒ¡ãƒ¼ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="main-content" style="display: none;">
      <!-- çµ±è¨ˆè¡¨ç¤º -->
      <div class="email-stats fade-in" id="email-stats">
        <div class="stat-card">
          <div class="stat-number" id="emails-sent-today">0</div>
          <div class="stat-label">ä»Šæ—¥é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="total-templates">2</div>
          <div class="stat-label">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="last-test-status">æœªå®Ÿè¡Œ</div>
          <div class="stat-label">æœ€å¾Œã®ãƒ†ã‚¹ãƒˆ</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="system-status">æ­£å¸¸</div>
          <div class="stat-label">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</div>
        </div>
      </div>

      <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <ul class="nav nav-tabs mb-4" id="settingsTabs">
        <li class="nav-item">
          <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic">
            <i class="bi bi-gear me-1"></i>åŸºæœ¬è¨­å®š
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates">
            <i class="bi bi-envelope me-1"></i>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="test-tab" data-bs-toggle="tab" data-bs-target="#test">
            <i class="bi bi-send me-1"></i>ãƒ†ã‚¹ãƒˆé€ä¿¡
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup">
            <i class="bi bi-shield-check me-1"></i>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          </button>
        </li>
      </ul>

      <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="tab-content" id="settingsTabContent">
        <!-- åŸºæœ¬è¨­å®šã‚¿ãƒ– -->
        <div class="tab-pane fade show active" id="basic">
          <div class="card fade-in">
            <div class="card-header">
              <i class="bi bi-gear me-2"></i>ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
            </div>
            <div class="card-body">
              <div class="help-text">
                <i class="bi bi-info-circle me-2"></i>
                <strong>AKåˆ—å¯¾å¿œç‰ˆï¼ˆv5.2ï¼‰</strong><br>
                ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®AKåˆ—ãŒäºˆç´„IDã«ãªã‚Šã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã§{orderId}å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦äºˆç´„IDã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="email-enabled" checked>
                    <label class="form-check-label fw-semibold" for="email-enabled">
                      <i class="bi bi-envelope me-1"></i>ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                    </label>
                  </div>
                  <div class="form-text">
                    ç„¡åŠ¹ã«ã™ã‚‹ã¨ã€äºˆç´„å®Œäº†æ™‚ã«ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œãªããªã‚Šã¾ã™
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="admin-email" class="form-label">
                    <i class="bi bi-person-badge me-1"></i>ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="text-danger">*</span>
                  </label>
                  <input type="email" class="form-control" id="admin-email"
                         placeholder="admin@example.com" required>
                  <div class="form-text">æ–°è¦äºˆç´„ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã™</div>
                  <div class="invalid-feedback">æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                  <div class="valid-feedback">æ­£ã—ãå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã™</div>
                </div>
              </div>
              
              <!-- è¿½åŠ è¨­å®š -->
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="email-from-name" class="form-label">
                    <i class="bi bi-person me-1"></i>é€ä¿¡è€…å
                  </label>
                  <input type="text" class="form-control" id="email-from-name"
                         placeholder="Hyggelyã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥å°‚é–€åº—">
                  <div class="form-text">ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡è€…ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹åå‰</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="email-reply-to" class="form-label">
                    <i class="bi bi-reply me-1"></i>è¿”ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                  </label>
                  <input type="email" class="form-control" id="email-reply-to"
                         placeholder="noreply@example.com">
                  <div class="form-text">é¡§å®¢ãŒè¿”ä¿¡ã™ã‚‹éš›ã®å®›å…ˆã‚¢ãƒ‰ãƒ¬ã‚¹</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ã‚¿ãƒ– -->
        <div class="tab-pane fade" id="templates">
          <!-- é¡§å®¢ç¢ºèªãƒ¡ãƒ¼ãƒ«è¨­å®š -->
          <div class="card fade-in mb-4">
            <div class="card-header">
              <i class="bi bi-envelope-check me-2"></i>é¡§å®¢ç¢ºèªãƒ¡ãƒ¼ãƒ«è¨­å®š
            </div>
            <div class="card-body">
              <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ -->
              <div class="template-selector mb-3">
                <label class="form-label">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</label>
                <div class="row">
                  <div class="col-md-6">
                    <div class="template-card" data-template="customer-default" onclick="selectTemplate('customer', 'default')">
                      <h6>æ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h6>
                      <p class="mb-0 text-muted small">åŸºæœ¬çš„ãªäºˆç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«ï¼ˆäºˆç´„IDä»˜ãï¼‰</p>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="template-card" data-template="customer-detailed" onclick="selectTemplate('customer', 'detailed')">
                      <h6>è©³ç´°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h6>
                      <p class="mb-0 text-muted small">è©³ç´°ãªæƒ…å ±ã‚’å«ã‚€ç¢ºèªãƒ¡ãƒ¼ãƒ«ï¼ˆäºˆç´„IDä»˜ãï¼‰</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- åˆ©ç”¨å¯èƒ½ãªå¤‰æ•° -->
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i><strong>åˆ©ç”¨å¯èƒ½ãªå¤‰æ•°ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æŒ¿å…¥ï¼‰:</strong>
                <div class="mt-2">
                  <span class="variable-tag" onclick="insertVariable('customer-body', '{lastName}')">
                    <i class="bi bi-person me-1"></i>{lastName}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('customer-body', '{firstName}')">
                    <i class="bi bi-person me-1"></i>{firstName}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('customer-body', '{email}')">
                    <i class="bi bi-envelope me-1"></i>{email}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('customer-body', '{orderItems}')">
                    <i class="bi bi-basket me-1"></i>{orderItems}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('customer-body', '{totalPrice}')">
                    <i class="bi bi-currency-yen me-1"></i>{totalPrice}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('customer-body', '{pickupDateTime}')">
                    <i class="bi bi-calendar me-1"></i>{pickupDateTime}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('customer-body', '{orderId}')">
                    <i class="bi bi-hash me-1"></i>{orderId} <span class="badge bg-success ms-1">NEW</span>
                  </span>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="customer-subject" class="form-label">
                  <i class="bi bi-envelope me-1"></i>ãƒ¡ãƒ¼ãƒ«ä»¶å <span class="text-danger">*</span>
                </label>
                <div class="position-relative">
                  <input type="text" class="form-control" id="customer-subject"
                         placeholder="ã”äºˆç´„å®Œäº†ç¢ºèª" required>
                  <div class="char-counter" id="customer-subject-counter">0/100</div>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="customer-body" class="form-label">
                  <i class="bi bi-file-text me-1"></i>ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ <span class="text-danger">*</span>
                </label>
                <div class="position-relative">
                  <textarea class="form-control" id="customer-body" rows="10"
                            placeholder="ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required></textarea>
                  <div class="char-counter" id="customer-body-counter">0/2000</div>
                </div>
              </div>

              <div class="d-flex justify-content-between flex-wrap gap-2">
                <div>
                  <button type="button" class="btn btn-preview me-2" onclick="previewCustomerEmail()">
                    <i class="bi bi-eye me-1"></i>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                  </button>
                  <button type="button" class="btn btn-info me-2" onclick="sendTestEmail('customer')">
                    <i class="bi bi-send me-1"></i>ãƒ†ã‚¹ãƒˆé€ä¿¡
                  </button>
                </div>
                <div>
                  <button type="button" class="btn btn-outline-secondary me-2" onclick="saveTemplate('customer')">
                    <i class="bi bi-floppy me-1"></i>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜
                  </button>
                  <button type="button" class="btn btn-warning" onclick="resetCustomerTemplate()">
                    <i class="bi bi-arrow-clockwise me-1"></i>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
                  </button>
                </div>
              </div>

              <div id="customer-preview" class="preview" style="display: none;"></div>
            </div>
          </div>

          <!-- ç®¡ç†è€…é€šçŸ¥ãƒ¡ãƒ¼ãƒ«è¨­å®š -->
          <div class="card fade-in">
            <div class="card-header">
              <i class="bi bi-envelope-exclamation me-2"></i>ç®¡ç†è€…é€šçŸ¥ãƒ¡ãƒ¼ãƒ«è¨­å®š
            </div>
            <div class="card-body">
              <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ -->
              <div class="template-selector mb-3">
                <label class="form-label">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</label>
                <div class="row">
                  <div class="col-md-6">
                    <div class="template-card" data-template="admin-default" onclick="selectTemplate('admin', 'default')">
                      <h6>æ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h6>
                      <p class="mb-0 text-muted small">åŸºæœ¬çš„ãªæ–°è¦äºˆç´„é€šçŸ¥ï¼ˆäºˆç´„IDä»˜ãï¼‰</p>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="template-card" data-template="admin-detailed" onclick="selectTemplate('admin', 'detailed')">
                      <h6>è©³ç´°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h6>
                      <p class="mb-0 text-muted small">è©³ç´°ãªäºˆç´„æƒ…å ±ã‚’å«ã‚€é€šçŸ¥ï¼ˆäºˆç´„IDä»˜ãï¼‰</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- åˆ©ç”¨å¯èƒ½ãªå¤‰æ•° -->
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i><strong>åˆ©ç”¨å¯èƒ½ãªå¤‰æ•°ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æŒ¿å…¥ï¼‰:</strong>
                <div class="mt-2">
                  <span class="variable-tag" onclick="insertVariable('admin-body', '{lastName}')">
                    <i class="bi bi-person me-1"></i>{lastName}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('admin-body', '{firstName}')">
                    <i class="bi bi-person me-1"></i>{firstName}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('admin-body', '{email}')">
                    <i class="bi bi-envelope me-1"></i>{email}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('admin-body', '{orderItems}')">
                    <i class="bi bi-basket me-1"></i>{orderItems}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('admin-body', '{totalPrice}')">
                    <i class="bi bi-currency-yen me-1"></i>{totalPrice}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('admin-body', '{pickupDateTime}')">
                    <i class="bi bi-calendar me-1"></i>{pickupDateTime}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('admin-body', '{orderId}')">
                    <i class="bi bi-hash me-1"></i>{orderId} <span class="badge bg-success ms-1">NEW</span>
                  </span>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="admin-subject" class="form-label">
                  <i class="bi bi-envelope me-1"></i>ãƒ¡ãƒ¼ãƒ«ä»¶å <span class="text-danger">*</span>
                </label>
                <div class="position-relative">
                  <input type="text" class="form-control" id="admin-subject"
                         placeholder="æ–°è¦äºˆç´„é€šçŸ¥" required>
                  <div class="char-counter" id="admin-subject-counter">0/100</div>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="admin-body" class="form-label">
                  <i class="bi bi-file-text me-1"></i>ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ <span class="text-danger">*</span>
                </label>
                <div class="position-relative">
                  <textarea class="form-control" id="admin-body" rows="10"
                            placeholder="ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required></textarea>
                  <div class="char-counter" id="admin-body-counter">0/2000</div>
                </div>
              </div>

              <div class="d-flex justify-content-between flex-wrap gap-2">
                <div>
                  <button type="button" class="btn btn-preview me-2" onclick="previewAdminEmail()">
                    <i class="bi bi-eye me-1"></i>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                  </button>
                  <button type="button" class="btn btn-info me-2" onclick="sendTestEmail('admin')">
                    <i class="bi bi-send me-1"></i>ãƒ†ã‚¹ãƒˆé€ä¿¡
                  </button>
                </div>
                <div>
                  <button type="button" class="btn btn-outline-secondary me-2" onclick="saveTemplate('admin')">
                    <i class="bi bi-floppy me-1"></i>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜
                  </button>
                  <button type="button" class="btn btn-warning" onclick="resetAdminTemplate()">
                    <i class="bi bi-arrow-clockwise me-1"></i>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
                  </button>
                </div>
              </div>

              <div id="admin-preview" class="preview" style="display: none;"></div>
            </div>
          </div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆé€ä¿¡ã‚¿ãƒ– -->
        <div class="tab-pane fade" id="test">
          <div class="card fade-in">
            <div class="card-header">
              <i class="bi bi-send me-2"></i>ãƒ¡ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆé€ä¿¡
            </div>
            <div class="card-body">
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚è¨­å®šã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆäºˆç´„IDä»˜ãï¼‰ã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã€‚
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="test-email" class="form-label">
                    <i class="bi bi-envelope me-1"></i>ãƒ†ã‚¹ãƒˆé€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                  </label>
                  <input type="email" class="form-control" id="test-email" 
                         placeholder="test@example.com" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="test-type" class="form-label">
                    <i class="bi bi-list me-1"></i>é€ä¿¡ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—
                  </label>
                  <select class="form-select" id="test-type">
                    <option value="customer">é¡§å®¢ç¢ºèªãƒ¡ãƒ¼ãƒ«</option>
                    <option value="admin">ç®¡ç†è€…é€šçŸ¥ãƒ¡ãƒ¼ãƒ«</option>
                    <option value="both">ä¸¡æ–¹</option>
                  </select>
                </div>
              </div>
              
              <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º -->
              <div class="card bg-light mb-3">
                <div class="card-header">
                  <i class="bi bi-database me-2"></i>ãƒ†ã‚¹ãƒˆç”¨ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆv5.2å¯¾å¿œï¼‰
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <small>
                        <strong>é¡§å®¢æƒ…å ±:</strong><br>
                        å±±ç”° å¤ªéƒ (yamada@example.com)<br>
                        å—å–æ—¥æ™‚: 2025å¹´01æœˆ15æ—¥ 14:00<br>
                        <span class="badge bg-success">äºˆç´„ID: ORD250115140030</span>
                      </small>
                    </div>
                    <div class="col-md-6">
                      <small>
                        <strong>æ³¨æ–‡å†…å®¹:</strong><br>
                        ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥ Ã—1 Â¥1,000<br>
                        ãƒ¬ãƒ¼ã‚ºãƒ³&ã‚¯ãƒ«ãƒŸ Ã—2 Â¥2,400<br>
                        åˆè¨ˆ: Â¥3,400
                      </small>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary btn-lg" onclick="executeEmailTest()">
                  <i class="bi bi-send me-2"></i>ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡
                </button>
              </div>
              
              <!-- ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º -->
              <div id="test-results" class="mt-3" style="display: none;">
                <div class="alert alert-success">
                  <h6><i class="bi bi-check-circle me-2"></i>ãƒ†ã‚¹ãƒˆé€ä¿¡å®Œäº†</h6>
                  <p id="test-result-message" class="mb-0"></p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¿ãƒ– -->
        <div class="tab-pane fade" id="backup">
          <div class="card fade-in">
            <div class="card-header">
              <i class="bi bi-shield-check me-2"></i>è¨­å®šã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨å¾©å…ƒ
            </div>
            <div class="card-body">
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>v5.2å¯¾å¿œã«ã¤ã„ã¦</strong><br>
                ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯AKåˆ—ãŒäºˆç´„IDã«å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ã€‚å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹éš›ã¯ã€
                ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«{orderId}å¤‰æ•°ãŒæ­£ã—ãå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
              </div>

              <div class="backup-section">
                <h6><i class="bi bi-download me-2"></i>è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h6>
                <p class="text-muted">ç¾åœ¨ã®ãƒ¡ãƒ¼ãƒ«è¨­å®šã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>
                <button type="button" class="btn btn-outline-primary" onclick="exportSettings()">
                  <i class="bi bi-download me-1"></i>è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </button>
              </div>
              
              <div class="backup-section">
                <h6><i class="bi bi-upload me-2"></i>è¨­å®šã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h6>
                <p class="text-muted">ä»¥å‰ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒã§ãã¾ã™ã€‚</p>
                <div class="mb-3">
                  <input type="file" class="form-control" id="import-file" accept=".json">
                </div>
                <button type="button" class="btn btn-outline-warning" onclick="importSettings()">
                  <i class="bi bi-upload me-1"></i>è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                </button>
              </div>
              
              <div class="backup-section">
                <h6><i class="bi bi-arrow-clockwise me-2"></i>å·¥å ´å‡ºè·æ™‚è¨­å®šã«æˆ»ã™</h6>
                <p class="text-muted text-danger">
                  <i class="bi bi-exclamation-triangle me-1"></i>
                  ã™ã¹ã¦ã®ãƒ¡ãƒ¼ãƒ«è¨­å®šãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆv5.2å¯¾å¿œç‰ˆï¼‰ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                </p>
                <button type="button" class="btn btn-danger" onclick="resetToFactory()">
                  <i class="bi bi-exclamation-triangle me-1"></i>å·¥å ´å‡ºè·æ™‚è¨­å®šã«æˆ»ã™
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
      <div class="card fade-in">
        <div class="card-body text-center">
          <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            <button type="button" class="btn btn-success btn-lg me-md-3" onclick="saveEmailSettings()">
              <i class="bi bi-check-circle me-2"></i>è¨­å®šã‚’ä¿å­˜
            </button>
            <button type="button" class="btn btn-secondary btn-lg me-md-3" onclick="loadEmailSettings()">
              <i class="bi bi-arrow-clockwise me-2"></i>è¨­å®šã‚’å†èª­ã¿è¾¼ã¿
            </button>
            <button type="button" class="btn btn-info btn-lg" onclick="validateAllSettings()">
              <i class="bi bi-check2-square me-2"></i>è¨­å®šã‚’æ¤œè¨¼
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentSettings = {};
    let templateLibrary = {};

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆv5.2å¯¾å¿œç‰ˆï¼‰
    const defaultTemplates = {
      customer: {
        default: {
          subject: 'Hyggelyã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥å°‚é–€åº— ã”äºˆç´„å®Œäº†ç¢ºèª',
          body: '{lastName} {firstName} æ§˜\n\nHyggelyäº‹å‰äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã‚’ã”åˆ©ç”¨ã„ãŸã ãèª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\nä»¥ä¸‹ã®æ³¨æ–‡å†…å®¹ã§æ‰¿ã‚Šã¾ã—ãŸã®ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚\n\näºˆç´„ID: {orderId}\n\n{orderItems}\n\nãƒ»åˆè¨ˆã€€ã€€ã€€Â¥{totalPrice}\n\nãƒ»å—å–æ—¥æ™‚ï¼š{pickupDateTime}\n\nå—å–æ—¥å½“æ—¥ã«ç¾é‡‘ã¾ãŸã¯PayPayã§ãŠæ”¯æ‰•ã„ã„ãŸã ãã¾ã™ã€‚\nå½“æ—¥ã¯æ°—ã‚’ã¤ã‘ã¦ãŠè¶Šã—ãã ã•ã„ã€‚\n\nâ€»ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚è¿”ä¿¡ã¯ã§ãã¾ã›ã‚“ã®ã§ã”äº†æ‰¿ãã ã•ã„ã€‚\nã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€Hyggelyå…¬å¼LINEã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚'
        },
        detailed: {
          subject: 'ã€äºˆç´„ç¢ºèªã€‘Hyggelyã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥å°‚é–€åº— - {orderId}',
          body: '{lastName} {firstName} æ§˜\n\nã“ã®åº¦ã¯ã€Hyggelyã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥å°‚é–€åº—ã‚’ã”åˆ©ç”¨ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nã€€äºˆç´„å†…å®¹ç¢ºèª\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\näºˆç´„ID: {orderId}\nãŠåå‰: {lastName} {firstName} æ§˜\nãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: {email}\nå—å–æ—¥æ™‚: {pickupDateTime}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nã€€ã”æ³¨æ–‡å•†å“\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n{orderItems}\n\nåˆè¨ˆé‡‘é¡: Â¥{totalPrice}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nã€€ãŠæ”¯æ‰•ã„ãƒ»ãŠå—ã‘å–ã‚Šã«ã¤ã„ã¦\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nãƒ»ãŠæ”¯æ‰•ã„æ–¹æ³•: ç¾é‡‘ ã¾ãŸã¯ PayPay\nãƒ»å—å–å ´æ‰€: åº—èˆ—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼\nãƒ»å–¶æ¥­æ™‚é–“: 11:00-17:00ï¼ˆæ°´æ›œæ—¥ãƒ»åœŸæ›œæ—¥ã®ã¿ï¼‰\n\nã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚\n\nâ€»ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚\n\nHyggelyã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥å°‚é–€åº—'
        }
      },
      admin: {
        default: {
          subject: 'ã€æ–°è¦äºˆç´„ã€‘{lastName} {firstName}æ§˜ - {orderId}',
          body: 'ã€æ–°è¦äºˆç´„é€šçŸ¥ã€‘\n\näºˆç´„ID: {orderId}\n\nãŠå®¢æ§˜æƒ…å ±:\nãƒ»æ°å: {lastName} {firstName} æ§˜\nãƒ»ãƒ¡ãƒ¼ãƒ«: {email}\nãƒ»å—å–æ—¥æ™‚: {pickupDateTime}\n\næ³¨æ–‡å†…å®¹:\n{orderItems}\n\nåˆè¨ˆé‡‘é¡: Â¥{totalPrice}\n\nâ€»äºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚ˆã‚Šè‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚\nâ€»äºˆç´„ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚„å¤‰æ›´ãŒå¿…è¦ãªå ´åˆã¯ã€ãŠå®¢æ§˜ã«ç›´æ¥ã”é€£çµ¡ãã ã•ã„ã€‚'
        },
        detailed: {
          subject: 'ã€æ–°è¦äºˆç´„è©³ç´°ã€‘{lastName} {firstName}æ§˜ - Â¥{totalPrice} - {orderId}',
          body: 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\næ–°è¦äºˆç´„ãŒå…¥ã‚Šã¾ã—ãŸ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\näºˆç´„ID: {orderId}\nå—ä»˜æ—¥æ™‚: ' + new Date().toLocaleString('ja-JP') + '\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nãŠå®¢æ§˜æƒ…å ±\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\næ°å: {lastName} {firstName} æ§˜\nãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: {email}\nå—å–æ—¥æ™‚: {pickupDateTime}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nã”æ³¨æ–‡å†…å®¹\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n{orderItems}\n\nåˆè¨ˆé‡‘é¡: Â¥{totalPrice}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nå¯¾å¿œãŒå¿…è¦ãªä½œæ¥­\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâ–¡ å•†å“ã®æº–å‚™\nâ–¡ å—å–æ—¥æ™‚ã®ç¢ºèª\nâ–¡ åœ¨åº«çŠ¶æ³ã®ç¢ºèª\n\nç®¡ç†ç”»é¢: [ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰URL]\n\nâ€»ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯äºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚ˆã‚Šè‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚'
        }
      }
    };

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ“§ ãƒ¡ãƒ¼ãƒ«è¨­å®šç”»é¢èµ·å‹• v5.2 - AKåˆ—å¯¾å¿œç‰ˆ');
      loadEmailSettings();
      setupEventListeners();
      updateStatus('ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†', 'success');
    });

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
      setupCharCounter('customer-subject', 100);
      setupCharCounter('customer-body', 2000);
      setupCharCounter('admin-subject', 100);
      setupCharCounter('admin-body', 2000);

      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      document.getElementById('admin-email').addEventListener('input', validateEmail);
      document.getElementById('email-reply-to').addEventListener('input', validateEmail);
    }

    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¨­å®š
    function setupCharCounter(elementId, maxLength) {
      const element = document.getElementById(elementId);
      const counter = document.getElementById(elementId + '-counter');
      
      element.addEventListener('input', function() {
        const length = this.value.length;
        counter.textContent = `${length}/${maxLength}`;
        
        counter.className = 'char-counter';
        if (length > maxLength * 0.8) {
          counter.classList.add('warning');
        }
        if (length > maxLength * 0.95) {
          counter.classList.add('danger');
        }
      });
    }

    // ãƒ¡ãƒ¼ãƒ«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateEmail(event) {
      const email = event.target.value;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      
      if (email && !emailRegex.test(email)) {
        event.target.classList.add('is-invalid');
        event.target.classList.remove('is-valid');
      } else if (email) {
        event.target.classList.add('is-valid');
        event.target.classList.remove('is-invalid');
      } else {
        event.target.classList.remove('is-valid', 'is-invalid');
      }
    }

    // ãƒ¡ãƒ¼ãƒ«è¨­å®šèª­ã¿è¾¼ã¿
    function loadEmailSettings() {
      showLoading();
      updateStatus('è¨­å®šèª­ã¿è¾¼ã¿ä¸­', 'loading');
      
      google.script.run
        .withSuccessHandler(function(settings) {
          currentSettings = settings || {};
          populateForm(currentSettings);
          updateStats();
          hideLoading();
          updateStatus('èª­ã¿è¾¼ã¿å®Œäº†', 'success');
          showToast('ãƒ¡ãƒ¼ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
        })
        .withFailureHandler(function(error) {
          console.error('ãƒ¡ãƒ¼ãƒ«è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          hideLoading();
          updateStatus('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
          showToast('ãƒ¡ãƒ¼ãƒ«è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§è¡¨ç¤º
          populateForm(getDefaultSettings());
          updateStats();
        })
        .getEmailSettings();
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šå–å¾—ï¼ˆv5.2å¯¾å¿œç‰ˆï¼‰
    function getDefaultSettings() {
      return {
        adminEmail: 'hyggely2021@gmail.com',
        customerSubject: defaultTemplates.customer.default.subject,
        customerBody: defaultTemplates.customer.default.body,
        adminSubject: defaultTemplates.admin.default.subject,
        adminBody: defaultTemplates.admin.default.body,
        emailEnabled: true,
        fromName: 'Hyggelyã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥å°‚é–€åº—',
        replyTo: 'noreply@hyggely.com'
      };
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã«è¨­å®šå€¤ã‚’åæ˜ 
    function populateForm(settings) {
      document.getElementById('admin-email').value = settings.adminEmail || '';
      document.getElementById('customer-subject').value = settings.customerSubject || '';
      document.getElementById('customer-body').value = settings.customerBody || '';
      document.getElementById('admin-subject').value = settings.adminSubject || '';
      document.getElementById('admin-body').value = settings.adminBody || '';
      document.getElementById('email-enabled').checked = settings.emailEnabled !== false;
      document.getElementById('email-from-name').value = settings.fromName || '';
      document.getElementById('email-reply-to').value = settings.replyTo || '';

      // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
      ['customer-subject', 'customer-body', 'admin-subject', 'admin-body'].forEach(id => {
        const element = document.getElementById(id);
        element.dispatchEvent(new Event('input'));
      });
    }

    // çµ±è¨ˆæ›´æ–°
    function updateStats() {
      // å®Ÿéš›ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å ´åˆã¯ã€Google Apps Scriptã‹ã‚‰å–å¾—
      document.getElementById('emails-sent-today').textContent = '0'; // å®Ÿè£…äºˆå®š
      document.getElementById('total-templates').textContent = '4'; // v5.2ã§4ç¨®é¡ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
      document.getElementById('last-test-status').textContent = 'æœªå®Ÿè¡Œ';
      document.getElementById('system-status').textContent = currentSettings.emailEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹';
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ
    function selectTemplate(type, template) {
      const templateData = defaultTemplates[type][template];
      
      if (type === 'customer') {
        document.getElementById('customer-subject').value = templateData.subject;
        document.getElementById('customer-body').value = templateData.body;
      } else {
        document.getElementById('admin-subject').value = templateData.subject;
        document.getElementById('admin-body').value = templateData.body;
      }

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ã®é¸æŠçŠ¶æ…‹æ›´æ–°
      document.querySelectorAll(`[data-template^="${type}-"]`).forEach(card => {
        card.classList.remove('active');
      });
      document.querySelector(`[data-template="${type}-${template}"]`).classList.add('active');

      // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
      ['customer-subject', 'customer-body', 'admin-subject', 'admin-body'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.dispatchEvent(new Event('input'));
      });

      showToast(`${type === 'customer' ? 'é¡§å®¢' : 'ç®¡ç†è€…'}ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é©ç”¨ã—ã¾ã—ãŸ`, 'success');
    }

    // å¤‰æ•°æŒ¿å…¥
    function insertVariable(textareaId, variable) {
      const textarea = document.getElementById(textareaId);
      const cursorPos = textarea.selectionStart;
      const textBefore = textarea.value.substring(0, cursorPos);
      const textAfter = textarea.value.substring(textarea.selectionEnd);
      
      textarea.value = textBefore + variable + textAfter;
      textarea.focus();
      textarea.setSelectionRange(cursorPos + variable.length, cursorPos + variable.length);

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
      const tag = event.target.closest('.variable-tag');
      tag.classList.add('copied');
      setTimeout(() => tag.classList.remove('copied'), 500);
      
      showToast(`å¤‰æ•° ${variable} ã‚’æŒ¿å…¥ã—ã¾ã—ãŸ`, 'success');
      
      // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
      textarea.dispatchEvent(new Event('input'));
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ï¼ˆv5.2å¯¾å¿œç‰ˆï¼‰
    function previewCustomerEmail() {
      const subject = document.getElementById('customer-subject').value;
      const body = document.getElementById('customer-body').value;
      
      const sampleData = {
        lastName: 'å±±ç”°',
        firstName: 'å¤ªéƒ',
        email: 'yamada@example.com',
        orderItems: 'ãƒ»ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥ã€€1å€‹ã€€Â¥1,000\nãƒ»ãƒ¬ãƒ¼ã‚ºãƒ³&ã‚¯ãƒ«ãƒŸã€€2å€‹ã€€Â¥2,400',
        totalPrice: '3,400',
        pickupDateTime: '2025å¹´01æœˆ15æ—¥ 14:00',
        orderId: 'ORD250115140030' // v5.2å¯¾å¿œã®äºˆç´„ID
      };

      const previewSubject = replaceVariables(subject, sampleData);
      const previewBody = replaceVariables(body, sampleData);

      const preview = document.getElementById('customer-preview');
      preview.innerHTML = `
        <div class="preview-header">
          <i class="bi bi-envelope me-2"></i>é¡§å®¢ç¢ºèªãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆv5.2å¯¾å¿œï¼‰
        </div>
        <div class="email-preview">
          <strong>ä»¶å:</strong> ${escapeHtml(previewSubject)}<br><br>
          <strong>æœ¬æ–‡:</strong><br>
          <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${escapeHtml(previewBody)}</pre>
        </div>
      `;
      preview.style.display = 'block';
      preview.scrollIntoView({ behavior: 'smooth' });
    }

    function previewAdminEmail() {
      const subject = document.getElementById('admin-subject').value;
      const body = document.getElementById('admin-body').value;
      
      const sampleData = {
        lastName: 'å±±ç”°',
        firstName: 'å¤ªéƒ',
        email: 'yamada@example.com',
        orderItems: 'ãƒ»ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥ã€€1å€‹ã€€Â¥1,000\nãƒ»ãƒ¬ãƒ¼ã‚ºãƒ³&ã‚¯ãƒ«ãƒŸã€€2å€‹ã€€Â¥2,400',
        totalPrice: '3,400',
        pickupDateTime: '2025å¹´01æœˆ15æ—¥ 14:00',
        orderId: 'ORD250115140030' // v5.2å¯¾å¿œã®äºˆç´„ID
      };

      const previewSubject = replaceVariables(subject, sampleData);
      const previewBody = replaceVariables(body, sampleData);

      const preview = document.getElementById('admin-preview');
      preview.innerHTML = `
        <div class="preview-header">
          <i class="bi bi-envelope-exclamation me-2"></i>ç®¡ç†è€…é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆv5.2å¯¾å¿œï¼‰
        </div>
        <div class="email-preview">
          <strong>ä»¶å:</strong> ${escapeHtml(previewSubject)}<br><br>
          <strong>æœ¬æ–‡:</strong><br>
          <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${escapeHtml(previewBody)}</pre>
        </div>
      `;
      preview.style.display = 'block';
      preview.scrollIntoView({ behavior: 'smooth' });
    }

    // ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡
    function sendTestEmail(type) {
      const email = document.getElementById('admin-email').value;
      if (!email) {
        showToast('ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error');
        return;
      }

      updateStatus('ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­', 'loading');
      showToast('ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¦ã„ã¾ã™...', 'info');

      // å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†ï¼ˆå®Ÿè£…äºˆå®šï¼‰
      setTimeout(() => {
        updateStatus('é€ä¿¡å®Œäº†', 'success');
        showToast(`${type === 'customer' ? 'é¡§å®¢' : 'ç®¡ç†è€…'}ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆäºˆç´„IDä»˜ãï¼‰`, 'success');
      }, 2000);
    }

    // ãƒ†ã‚¹ãƒˆé€ä¿¡å®Ÿè¡Œ
    function executeEmailTest() {
      const testEmail = document.getElementById('test-email').value;
      const testType = document.getElementById('test-type').value;

      if (!testEmail) {
        showToast('ãƒ†ã‚¹ãƒˆé€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      updateStatus('ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­', 'loading');

      // å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆé€ä¿¡å‡¦ç†ï¼ˆå®Ÿè£…äºˆå®šï¼‰
      setTimeout(() => {
        const results = document.getElementById('test-results');
        const message = document.getElementById('test-result-message');
        
        message.textContent = `${testEmail} ã«ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ï¼ˆ${testType}ãƒ»äºˆç´„IDä»˜ãï¼‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`;
        results.style.display = 'block';
        results.scrollIntoView({ behavior: 'smooth' });
        
        updateStatus('é€ä¿¡å®Œäº†', 'success');
        showToast('ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†', 'success');
      }, 2000);
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜
    function saveTemplate(type) {
      const templateName = prompt(`${type === 'customer' ? 'é¡§å®¢' : 'ç®¡ç†è€…'}ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`);
      if (!templateName) return;

      const subject = document.getElementById(`${type}-subject`).value;
      const body = document.getElementById(`${type}-body`).value;

      if (!templateLibrary[type]) templateLibrary[type] = {};
      templateLibrary[type][templateName] = { subject, body };

      showToast(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${templateName}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`, 'success');
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªã‚»ãƒƒãƒˆ
    function resetCustomerTemplate() {
      if (confirm('é¡§å®¢ç¢ºèªãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆv5.2å¯¾å¿œç‰ˆï¼‰ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
        selectTemplate('customer', 'default');
        document.getElementById('customer-preview').style.display = 'none';
        showToast('é¡§å®¢ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ', 'success');
      }
    }

    function resetAdminTemplate() {
      if (confirm('ç®¡ç†è€…é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆv5.2å¯¾å¿œç‰ˆï¼‰ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
        selectTemplate('admin', 'default');
        document.getElementById('admin-preview').style.display = 'none';
        showToast('ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ', 'success');
      }
    }

    // è¨­å®šä¿å­˜
    function saveEmailSettings() {
      const adminEmail = document.getElementById('admin-email').value;
      const customerSubject = document.getElementById('customer-subject').value;
      const customerBody = document.getElementById('customer-body').value;
      const adminSubject = document.getElementById('admin-subject').value;
      const adminBody = document.getElementById('admin-body').value;

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!adminEmail || !customerSubject || !customerBody || !adminSubject || !adminBody) {
        showToast('ã™ã¹ã¦ã®å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      if (!isValidEmail(adminEmail)) {
        showToast('æœ‰åŠ¹ãªç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const settings = {
        adminEmail: adminEmail,
        customerSubject: customerSubject,
        customerBody: customerBody,
        adminSubject: adminSubject,
        adminBody: adminBody,
        emailEnabled: document.getElementById('email-enabled').checked,
        fromName: document.getElementById('email-from-name').value,
        replyTo: document.getElementById('email-reply-to').value
      };

      const button = event.target;
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<div class="spinner-border spinner-border-sm me-1"></div>ä¿å­˜ä¸­...';
      updateStatus('è¨­å®šä¿å­˜ä¸­', 'loading');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.success) {
            currentSettings = settings;
            showToast(result.message || 'è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆv5.2å¯¾å¿œç‰ˆï¼‰', 'success');
            updateStatus('ä¿å­˜å®Œäº†', 'success');
            
            // æˆåŠŸè¡¨ç¤º
            button.classList.remove('btn-success');
            button.classList.add('save-success');
            button.innerHTML = '<i class="bi bi-check-circle me-2"></i>ä¿å­˜å®Œäº†';
            
            setTimeout(() => {
              button.classList.remove('save-success');
              button.classList.add('btn-success');
              button.innerHTML = originalText;
              button.disabled = false;
            }, 2000);
          } else {
            showToast(result ? result.message : 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            updateStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
            button.disabled = false;
            button.innerHTML = originalText;
          }
        })
        .withFailureHandler(function(error) {
          console.error('ãƒ¡ãƒ¼ãƒ«è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          showToast('ãƒ¡ãƒ¼ãƒ«è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'error');
          updateStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
          button.disabled = false;
          button.innerHTML = originalText;
        })
        .updateEmailSettings(settings);
    }

    // è¨­å®šæ¤œè¨¼
    function validateAllSettings() {
      updateStatus('è¨­å®šæ¤œè¨¼ä¸­', 'loading');
      
      let isValid = true;
      const errors = [];

      // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
      const requiredFields = ['admin-email', 'customer-subject', 'customer-body', 'admin-subject', 'admin-body'];
      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
          errors.push(`${field.labels[0].textContent}ã¯å¿…é ˆã§ã™`);
          isValid = false;
        }
      });

      // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ãƒã‚§ãƒƒã‚¯
      const emailFields = ['admin-email', 'email-reply-to'];
      emailFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field.value && !isValidEmail(field.value)) {
          errors.push(`${field.labels[0].textContent}ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“`);
          isValid = false;
        }
      });

      // v5.2å¯¾å¿œãƒã‚§ãƒƒã‚¯ï¼š{orderId}å¤‰æ•°ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
      const customerBody = document.getElementById('customer-body').value;
      const adminBody = document.getElementById('admin-body').value;
      
      if (!customerBody.includes('{orderId}')) {
        errors.push('é¡§å®¢ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã«{orderId}å¤‰æ•°ã®è¿½åŠ ã‚’æ¨å¥¨ã—ã¾ã™ï¼ˆv5.2å¯¾å¿œï¼‰');
      }
      if (!adminBody.includes('{orderId}')) {
        errors.push('ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã«{orderId}å¤‰æ•°ã®è¿½åŠ ã‚’æ¨å¥¨ã—ã¾ã™ï¼ˆv5.2å¯¾å¿œï¼‰');
      }

      setTimeout(() => {
        if (isValid) {
          updateStatus('æ¤œè¨¼å®Œäº†', 'success');
          showToast('ã™ã¹ã¦ã®è¨­å®šãŒæ­£å¸¸ã§ã™ï¼ˆv5.2å¯¾å¿œï¼‰', 'success');
        } else {
          updateStatus('æ¤œè¨¼ã‚¨ãƒ©ãƒ¼', 'error');
          showToast('è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™:\n' + errors.join('\n'), 'error');
        }
      }, 1000);
    }

    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
    function exportSettings() {
      const settings = {
        ...currentSettings,
        exportDate: new Date().toISOString(),
        version: '5.2.0' // v5.2å¯¾å¿œç‰ˆ
      };

      const dataStr = JSON.stringify(settings, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `hyggely-email-settings-v5.2-${new Date().toISOString().split('T')[0]}.json`;
      link.click();

      showToast('è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆv5.2å¯¾å¿œç‰ˆï¼‰', 'success');
    }

    function importSettings() {
      const fileInput = document.getElementById('import-file');
      const file = fileInput.files[0];

      if (!file) {
        showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const settings = JSON.parse(e.target.result);
          
          // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
          if (settings.version && settings.version !== '5.2.0') {
            showToast(`ç•°ãªã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆ${settings.version}ï¼‰ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚{orderId}å¤‰æ•°ãŒæ­£ã—ãå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 'warning');
          }
          
          populateForm(settings);
          showToast('è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        } catch (error) {
          showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
      };
      reader.readAsText(file);
    }

    function resetToFactory() {
      if (confirm('æœ¬å½“ã«ã™ã¹ã¦ã®è¨­å®šã‚’å·¥å ´å‡ºè·æ™‚ã®çŠ¶æ…‹ï¼ˆv5.2å¯¾å¿œç‰ˆï¼‰ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        populateForm(getDefaultSettings());
        showToast('å·¥å ´å‡ºè·æ™‚è¨­å®šã«æˆ»ã—ã¾ã—ãŸï¼ˆv5.2å¯¾å¿œç‰ˆï¼‰', 'warning');
      }
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function replaceVariables(template, data) {
      let result = template;
      Object.keys(data).forEach(key => {
        const regex = new RegExp('{' + key + '}', 'g');
        result = result.replace(regex, data[key]);
      });
      return result;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function showLoading() {
      document.getElementById('loading').classList.add('show');
      document.getElementById('main-content').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
      document.getElementById('main-content').style.display = 'block';
    }

    function updateStatus(message, type) {
      const status = document.getElementById('status');
      let icon = 'bi-wifi';
      let color = 'rgba(40, 167, 69, 0.9)';
      
      switch (type) {
        case 'loading':
          icon = 'bi-arrow-clockwise';
          color = 'rgba(255, 193, 7, 0.9)';
          break;
        case 'error':
          icon = 'bi-exclamation-triangle';
          color = 'rgba(220, 53, 69, 0.9)';
          break;
        case 'success':
          icon = 'bi-check-circle';
          color = 'rgba(40, 167, 69, 0.9)';
          break;
      }
      
      status.innerHTML = `<i class="${icon}"></i> ${message}`;
      status.style.backgroundColor = color;
    }

    function showToast(message, type = 'success') {
      // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¹ãƒˆã‚’å‰Šé™¤
      document.querySelectorAll('.toast').forEach(toast => {
        const bsToast = bootstrap.Toast.getInstance(toast);
        if (bsToast) bsToast.hide();
      });

      let bgClass = 'bg-success';
      let iconClass = 'bi-check-circle';
      
      switch (type) {
        case 'error':
          bgClass = 'bg-danger';
          iconClass = 'bi-x-circle';
          break;
        case 'warning':
          bgClass = 'bg-warning';
          iconClass = 'bi-exclamation-triangle';
          break;
        case 'info':
          bgClass = 'bg-info';
          iconClass = 'bi-info-circle';
          break;
      }

      const toastHtml = `
        <div class="toast align-items-center text-white ${bgClass} border-0"
             style="position: fixed; top: 100px; right: 20px; z-index: 1100; min-width: 350px;">
          <div class="d-flex">
            <div class="toast-body">
              <i class="${iconClass} me-2"></i>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', toastHtml);
      
      const toastElement = document.body.lastElementChild;
      const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: type === 'error' ? 8000 : 5000
      });
      
      toast.show();

      toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
      });
    }
  </script>
</body>
</html>