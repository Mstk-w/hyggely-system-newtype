<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hyggelyカンパーニュ専門店 メール設定 v5.2</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    body {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      min-height: 100vh;
    }
    
    /* ナビゲーション */
    .navbar {
      background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%) !important;
      box-shadow: 0 4px 20px rgba(139, 69, 19, 0.3);
    }
    .navbar-brand { font-weight: bold; color: white !important; }
    .nav-link {
      color: rgba(255, 255, 255, 0.9) !important;
      transition: all 0.3s ease;
      border-radius: 6px;
      margin: 0 3px;
      padding: 8px 12px !important;
    }
    .nav-link:hover {
      color: white !important;
      background: rgba(255, 255, 255, 0.1);
    }
    
    /* カード */
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      margin-bottom: 1.5rem;
      background: rgba(255, 255, 255, 0.95);
      transition: all 0.3s ease;
    }
    .card:hover {
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    .card-header {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-bottom: 2px solid rgba(139, 69, 19, 0.1);
      font-weight: 700;
      padding: 1rem 1.5rem;
      border-radius: 12px 12px 0 0;
    }
    .card-body { padding: 1.5rem; }
    
    /* フォーム */
    .form-control, .form-select {
      border-radius: 8px;
      border: 2px solid #e9ecef;
      padding: 12px 16px;
      transition: all 0.3s ease;
    }
    .form-control:focus, .form-select:focus {
      border-color: #8B4513;
      box-shadow: 0 0 0 0.2rem rgba(139, 69, 19, 0.15);
    }
    .form-control:valid {
      border-color: #28a745;
    }
    .form-control:invalid {
      border-color: #dc3545;
    }
    
    /* ボタン */
    .btn-primary {
      background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
      border: none;
      border-radius: 8px;
      font-weight: 600;
      padding: 12px 24px;
      transition: all 0.3s ease;
    }
    .btn-primary:hover { 
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(139, 69, 19, 0.3);
    }
    
    /* 変数タグ */
    .variable-tag {
      background: #8B4513;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      margin: 3px;
      display: inline-block;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    .variable-tag:hover {
      background: #a0522d;
      transform: scale(1.05);
      border-color: #8B4513;
    }
    .variable-tag.copied {
      background: #28a745;
      animation: pulse 0.5s ease;
    }
    
    /* プレビュー */
    .preview {
      background: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 1rem;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 400px;
      overflow-y: auto;
      position: relative;
    }
    .preview.email-preview {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 2px solid #8B4513;
    }
    .preview-header {
      background: #e9ecef;
      margin: -1.5rem -1.5rem 1rem -1.5rem;
      padding: 1rem 1.5rem;
      border-radius: 6px 6px 0 0;
      font-weight: bold;
      color: #495057;
    }
    
    /* テンプレート管理 */
    .template-selector {
      margin-bottom: 1rem;
    }
    .template-card {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .template-card:hover {
      border-color: #8B4513;
      background: rgba(139, 69, 19, 0.05);
    }
    .template-card.active {
      border-color: #8B4513;
      background: rgba(139, 69, 19, 0.1);
    }
    
    /* タブ */
    .nav-tabs .nav-link {
      border-radius: 8px 8px 0 0;
      color: #6c757d;
      font-weight: 600;
    }
    .nav-tabs .nav-link.active {
      background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
      color: white;
      border-color: transparent;
    }
    
    /* ローディング */
    .loading {
      display: none;
      text-align: center;
      padding: 3rem;
    }
    .loading.show { display: block; }
    
    /* ステータス表示 */
    .status-indicator {
      position: fixed;
      top: 70px;
      right: 15px;
      z-index: 1000;
      background: rgba(40, 167, 69, 0.9);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.8rem;
    }
    
    /* 統計表示 */
    .email-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      border: 2px solid #e9ecef;
      text-align: center;
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      border-color: #8B4513;
      box-shadow: 0 4px 15px rgba(139, 69, 19, 0.1);
    }
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #8B4513;
    }
    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    
    /* 文字数カウンター */
    .char-counter {
      position: absolute;
      bottom: 10px;
      right: 15px;
      font-size: 0.8rem;
      color: #6c757d;
      background: rgba(255, 255, 255, 0.9);
      padding: 2px 8px;
      border-radius: 4px;
    }
    .char-counter.warning {
      color: #ffc107;
    }
    .char-counter.danger {
      color: #dc3545;
    }
    
    /* バックアップ機能 */
    .backup-section {
      background: #e3f2fd;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }
    
    /* レスポンシブ最適化 */
    @media (max-width: 768px) {
      .container-fluid { padding: 0.5rem; }
      .card { margin-bottom: 1rem; }
      .card-body { padding: 1rem; }
      .navbar-brand { font-size: 1rem; }
      .variable-tag {
        font-size: 0.7rem;
        padding: 4px 8px;
        margin: 2px;
      }
      .preview {
        font-size: 0.8rem;
        max-height: 250px;
      }
      .stat-number { font-size: 1.5rem; }
    }
    
    /* アニメーション */
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.05); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* テーマ切り替え */
    .theme-selector {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    /* ヘルプテキスト強化 */
    .help-text {
      background: #f8f9fa;
      border-left: 4px solid #8B4513;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 0 8px 8px 0;
    }

    /* プレビューボタン強化 */
    .btn-preview {
      background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
      border: none;
      color: white;
    }
    .btn-preview:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
    }

    /* 成功表示の強化 */
    .save-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      animation: saveSuccess 0.5s ease;
    }
    @keyframes saveSuccess {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <!-- ステータス表示 -->
  <div class="status-indicator pulse" id="status">
    <i class="bi bi-wifi"></i> 接続中
  </div>

  <!-- ナビゲーション -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="bi bi-envelope-gear me-2"></i>Hyggelyメール設定 v5.2
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="?action=dashboard&password=hyggelyAdmin2024" target="_blank">
            <i class="bi bi-speedometer2 me-1"></i>ダッシュボード
          </a>
          <a class="nav-link" href="?" target="_blank">
            <i class="bi bi-box-arrow-up-right me-1"></i>予約フォーム
          </a>
          <a class="nav-link" href="#" onclick="loadEmailSettings()">
            <i class="bi bi-arrow-clockwise me-1"></i>更新
          </a>
          <a class="nav-link" href="#" onclick="exportSettings()">
            <i class="bi bi-download me-1"></i>エクスポート
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-3">
    <!-- ローディング画面 -->
    <div class="loading" id="loading">
      <div class="spinner-border" style="color: #8B4513;"></div>
      <p class="mt-3">メール設定を読み込んでいます...</p>
    </div>

    <!-- メイン画面 -->
    <div id="main-content" style="display: none;">
      <!-- 統計表示 -->
      <div class="email-stats fade-in" id="email-stats">
        <div class="stat-card">
          <div class="stat-number" id="emails-sent-today">0</div>
          <div class="stat-label">今日送信されたメール</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="total-templates">2</div>
          <div class="stat-label">テンプレート数</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="last-test-status">未実行</div>
          <div class="stat-label">最後のテスト</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="system-status">正常</div>
          <div class="stat-label">システム状態</div>
        </div>
      </div>

      <!-- タブナビゲーション -->
      <ul class="nav nav-tabs mb-4" id="settingsTabs">
        <li class="nav-item">
          <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic">
            <i class="bi bi-gear me-1"></i>基本設定
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates">
            <i class="bi bi-envelope me-1"></i>テンプレート管理
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="test-tab" data-bs-toggle="tab" data-bs-target="#test">
            <i class="bi bi-send me-1"></i>テスト送信
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup">
            <i class="bi bi-shield-check me-1"></i>バックアップ
          </button>
        </li>
      </ul>

      <!-- タブコンテンツ -->
      <div class="tab-content" id="settingsTabContent">
        <!-- 基本設定タブ -->
        <div class="tab-pane fade show active" id="basic">
          <div class="card fade-in">
            <div class="card-header">
              <i class="bi bi-gear me-2"></i>システム設定
            </div>
            <div class="card-body">
              <div class="help-text">
                <i class="bi bi-info-circle me-2"></i>
                <strong>AK列対応版（v5.2）</strong><br>
                スプレッドシートのAK列が予約IDになりました。メール本文で{orderId}変数を使用して予約IDを表示できます。
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="email-enabled" checked>
                    <label class="form-check-label fw-semibold" for="email-enabled">
                      <i class="bi bi-envelope me-1"></i>メール送信機能を有効にする
                    </label>
                  </div>
                  <div class="form-text">
                    無効にすると、予約完了時にメールが送信されなくなります
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="admin-email" class="form-label">
                    <i class="bi bi-person-badge me-1"></i>管理者メールアドレス <span class="text-danger">*</span>
                  </label>
                  <input type="email" class="form-control" id="admin-email"
                         placeholder="admin@example.com" required>
                  <div class="form-text">新規予約の通知メールが送信されます</div>
                  <div class="invalid-feedback">有効なメールアドレスを入力してください</div>
                  <div class="valid-feedback">正しく入力されています</div>
                </div>
              </div>
              
              <!-- 追加設定 -->
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="email-from-name" class="form-label">
                    <i class="bi bi-person me-1"></i>送信者名
                  </label>
                  <input type="text" class="form-control" id="email-from-name"
                         placeholder="Hyggelyカンパーニュ専門店">
                  <div class="form-text">メールの送信者として表示される名前</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="email-reply-to" class="form-label">
                    <i class="bi bi-reply me-1"></i>返信先メールアドレス
                  </label>
                  <input type="email" class="form-control" id="email-reply-to"
                         placeholder="noreply@example.com">
                  <div class="form-text">顧客が返信する際の宛先アドレス</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- テンプレート管理タブ -->
        <div class="tab-pane fade" id="templates">
          <!-- 顧客確認メール設定 -->
          <div class="card fade-in mb-4">
            <div class="card-header">
              <i class="bi bi-envelope-check me-2"></i>顧客確認メール設定
            </div>
            <div class="card-body">
              <!-- テンプレート選択 -->
              <div class="template-selector mb-3">
                <label class="form-label">テンプレート選択</label>
                <div class="row">
                  <div class="col-md-6">
                    <div class="template-card" data-template="customer-default" onclick="selectTemplate('customer', 'default')">
                      <h6>標準テンプレート</h6>
                      <p class="mb-0 text-muted small">基本的な予約確認メール（予約ID付き）</p>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="template-card" data-template="customer-detailed" onclick="selectTemplate('customer', 'detailed')">
                      <h6>詳細テンプレート</h6>
                      <p class="mb-0 text-muted small">詳細な情報を含む確認メール（予約ID付き）</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 利用可能な変数 -->
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i><strong>利用可能な変数（クリックで挿入）:</strong>
                <div class="mt-2">
                  <span class="variable-tag" onclick="insertVariable('customer-body', '{lastName}')">
                    <i class="bi bi-person me-1"></i>{lastName}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('customer-body', '{firstName}')">
                    <i class="bi bi-person me-1"></i>{firstName}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('customer-body', '{email}')">
                    <i class="bi bi-envelope me-1"></i>{email}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('customer-body', '{orderItems}')">
                    <i class="bi bi-basket me-1"></i>{orderItems}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('customer-body', '{totalPrice}')">
                    <i class="bi bi-currency-yen me-1"></i>{totalPrice}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('customer-body', '{pickupDateTime}')">
                    <i class="bi bi-calendar me-1"></i>{pickupDateTime}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('customer-body', '{orderId}')">
                    <i class="bi bi-hash me-1"></i>{orderId} <span class="badge bg-success ms-1">NEW</span>
                  </span>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="customer-subject" class="form-label">
                  <i class="bi bi-envelope me-1"></i>メール件名 <span class="text-danger">*</span>
                </label>
                <div class="position-relative">
                  <input type="text" class="form-control" id="customer-subject"
                         placeholder="ご予約完了確認" required>
                  <div class="char-counter" id="customer-subject-counter">0/100</div>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="customer-body" class="form-label">
                  <i class="bi bi-file-text me-1"></i>メール本文 <span class="text-danger">*</span>
                </label>
                <div class="position-relative">
                  <textarea class="form-control" id="customer-body" rows="10"
                            placeholder="メール本文を入力してください" required></textarea>
                  <div class="char-counter" id="customer-body-counter">0/2000</div>
                </div>
              </div>

              <div class="d-flex justify-content-between flex-wrap gap-2">
                <div>
                  <button type="button" class="btn btn-preview me-2" onclick="previewCustomerEmail()">
                    <i class="bi bi-eye me-1"></i>プレビュー
                  </button>
                  <button type="button" class="btn btn-info me-2" onclick="sendTestEmail('customer')">
                    <i class="bi bi-send me-1"></i>テスト送信
                  </button>
                </div>
                <div>
                  <button type="button" class="btn btn-outline-secondary me-2" onclick="saveTemplate('customer')">
                    <i class="bi bi-floppy me-1"></i>テンプレート保存
                  </button>
                  <button type="button" class="btn btn-warning" onclick="resetCustomerTemplate()">
                    <i class="bi bi-arrow-clockwise me-1"></i>デフォルトに戻す
                  </button>
                </div>
              </div>

              <div id="customer-preview" class="preview" style="display: none;"></div>
            </div>
          </div>

          <!-- 管理者通知メール設定 -->
          <div class="card fade-in">
            <div class="card-header">
              <i class="bi bi-envelope-exclamation me-2"></i>管理者通知メール設定
            </div>
            <div class="card-body">
              <!-- テンプレート選択 -->
              <div class="template-selector mb-3">
                <label class="form-label">テンプレート選択</label>
                <div class="row">
                  <div class="col-md-6">
                    <div class="template-card" data-template="admin-default" onclick="selectTemplate('admin', 'default')">
                      <h6>標準テンプレート</h6>
                      <p class="mb-0 text-muted small">基本的な新規予約通知（予約ID付き）</p>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="template-card" data-template="admin-detailed" onclick="selectTemplate('admin', 'detailed')">
                      <h6>詳細テンプレート</h6>
                      <p class="mb-0 text-muted small">詳細な予約情報を含む通知（予約ID付き）</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 利用可能な変数 -->
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i><strong>利用可能な変数（クリックで挿入）:</strong>
                <div class="mt-2">
                  <span class="variable-tag" onclick="insertVariable('admin-body', '{lastName}')">
                    <i class="bi bi-person me-1"></i>{lastName}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('admin-body', '{firstName}')">
                    <i class="bi bi-person me-1"></i>{firstName}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('admin-body', '{email}')">
                    <i class="bi bi-envelope me-1"></i>{email}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('admin-body', '{orderItems}')">
                    <i class="bi bi-basket me-1"></i>{orderItems}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('admin-body', '{totalPrice}')">
                    <i class="bi bi-currency-yen me-1"></i>{totalPrice}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('admin-body', '{pickupDateTime}')">
                    <i class="bi bi-calendar me-1"></i>{pickupDateTime}
                  </span>
                  <span class="variable-tag" onclick="insertVariable('admin-body', '{orderId}')">
                    <i class="bi bi-hash me-1"></i>{orderId} <span class="badge bg-success ms-1">NEW</span>
                  </span>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="admin-subject" class="form-label">
                  <i class="bi bi-envelope me-1"></i>メール件名 <span class="text-danger">*</span>
                </label>
                <div class="position-relative">
                  <input type="text" class="form-control" id="admin-subject"
                         placeholder="新規予約通知" required>
                  <div class="char-counter" id="admin-subject-counter">0/100</div>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="admin-body" class="form-label">
                  <i class="bi bi-file-text me-1"></i>メール本文 <span class="text-danger">*</span>
                </label>
                <div class="position-relative">
                  <textarea class="form-control" id="admin-body" rows="10"
                            placeholder="メール本文を入力してください" required></textarea>
                  <div class="char-counter" id="admin-body-counter">0/2000</div>
                </div>
              </div>

              <div class="d-flex justify-content-between flex-wrap gap-2">
                <div>
                  <button type="button" class="btn btn-preview me-2" onclick="previewAdminEmail()">
                    <i class="bi bi-eye me-1"></i>プレビュー
                  </button>
                  <button type="button" class="btn btn-info me-2" onclick="sendTestEmail('admin')">
                    <i class="bi bi-send me-1"></i>テスト送信
                  </button>
                </div>
                <div>
                  <button type="button" class="btn btn-outline-secondary me-2" onclick="saveTemplate('admin')">
                    <i class="bi bi-floppy me-1"></i>テンプレート保存
                  </button>
                  <button type="button" class="btn btn-warning" onclick="resetAdminTemplate()">
                    <i class="bi bi-arrow-clockwise me-1"></i>デフォルトに戻す
                  </button>
                </div>
              </div>

              <div id="admin-preview" class="preview" style="display: none;"></div>
            </div>
          </div>
        </div>

        <!-- テスト送信タブ -->
        <div class="tab-pane fade" id="test">
          <div class="card fade-in">
            <div class="card-header">
              <i class="bi bi-send me-2"></i>メールテスト送信
            </div>
            <div class="card-body">
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                実際のメール送信をテストできます。設定したテンプレートでサンプルデータ（予約ID付き）を使用してメールを送信します。
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="test-email" class="form-label">
                    <i class="bi bi-envelope me-1"></i>テスト送信先メールアドレス
                  </label>
                  <input type="email" class="form-control" id="test-email" 
                         placeholder="test@example.com" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="test-type" class="form-label">
                    <i class="bi bi-list me-1"></i>送信テストタイプ
                  </label>
                  <select class="form-select" id="test-type">
                    <option value="customer">顧客確認メール</option>
                    <option value="admin">管理者通知メール</option>
                    <option value="both">両方</option>
                  </select>
                </div>
              </div>
              
              <!-- サンプルデータ表示 -->
              <div class="card bg-light mb-3">
                <div class="card-header">
                  <i class="bi bi-database me-2"></i>テスト用サンプルデータ（v5.2対応）
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <small>
                        <strong>顧客情報:</strong><br>
                        山田 太郎 (yamada@example.com)<br>
                        受取日時: 2025年01月15日 14:00<br>
                        <span class="badge bg-success">予約ID: ORD250115140030</span>
                      </small>
                    </div>
                    <div class="col-md-6">
                      <small>
                        <strong>注文内容:</strong><br>
                        プレミアムカンパーニュ ×1 ¥1,000<br>
                        レーズン&クルミ ×2 ¥2,400<br>
                        合計: ¥3,400
                      </small>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary btn-lg" onclick="executeEmailTest()">
                  <i class="bi bi-send me-2"></i>テストメール送信
                </button>
              </div>
              
              <!-- テスト結果表示 -->
              <div id="test-results" class="mt-3" style="display: none;">
                <div class="alert alert-success">
                  <h6><i class="bi bi-check-circle me-2"></i>テスト送信完了</h6>
                  <p id="test-result-message" class="mb-0"></p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- バックアップタブ -->
        <div class="tab-pane fade" id="backup">
          <div class="card fade-in">
            <div class="card-header">
              <i class="bi bi-shield-check me-2"></i>設定のバックアップと復元
            </div>
            <div class="card-body">
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>v5.2対応について</strong><br>
                このバージョンではAK列が予約IDに変更されています。古いバージョンの設定ファイルをインポートする際は、
                テンプレートに{orderId}変数が正しく含まれているか確認してください。
              </div>

              <div class="backup-section">
                <h6><i class="bi bi-download me-2"></i>設定のエクスポート</h6>
                <p class="text-muted">現在のメール設定をJSONファイルとしてダウンロードできます。</p>
                <button type="button" class="btn btn-outline-primary" onclick="exportSettings()">
                  <i class="bi bi-download me-1"></i>設定をエクスポート
                </button>
              </div>
              
              <div class="backup-section">
                <h6><i class="bi bi-upload me-2"></i>設定のインポート</h6>
                <p class="text-muted">以前にエクスポートした設定ファイルから復元できます。</p>
                <div class="mb-3">
                  <input type="file" class="form-control" id="import-file" accept=".json">
                </div>
                <button type="button" class="btn btn-outline-warning" onclick="importSettings()">
                  <i class="bi bi-upload me-1"></i>設定をインポート
                </button>
              </div>
              
              <div class="backup-section">
                <h6><i class="bi bi-arrow-clockwise me-2"></i>工場出荷時設定に戻す</h6>
                <p class="text-muted text-danger">
                  <i class="bi bi-exclamation-triangle me-1"></i>
                  すべてのメール設定がデフォルト値（v5.2対応版）にリセットされます。この操作は取り消せません。
                </p>
                <button type="button" class="btn btn-danger" onclick="resetToFactory()">
                  <i class="bi bi-exclamation-triangle me-1"></i>工場出荷時設定に戻す
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 保存ボタン -->
      <div class="card fade-in">
        <div class="card-body text-center">
          <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            <button type="button" class="btn btn-success btn-lg me-md-3" onclick="saveEmailSettings()">
              <i class="bi bi-check-circle me-2"></i>設定を保存
            </button>
            <button type="button" class="btn btn-secondary btn-lg me-md-3" onclick="loadEmailSettings()">
              <i class="bi bi-arrow-clockwise me-2"></i>設定を再読み込み
            </button>
            <button type="button" class="btn btn-info btn-lg" onclick="validateAllSettings()">
              <i class="bi bi-check2-square me-2"></i>設定を検証
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentSettings = {};
    let templateLibrary = {};

    // デフォルトテンプレート（v5.2対応版）
    const defaultTemplates = {
      customer: {
        default: {
          subject: 'Hyggelyカンパーニュ専門店 ご予約完了確認',
          body: '{lastName} {firstName} 様\n\nHyggely事前予約システムをご利用いただき誠にありがとうございます。\n以下の注文内容で承りましたのでお知らせします。\n\n予約ID: {orderId}\n\n{orderItems}\n\n・合計　　　¥{totalPrice}\n\n・受取日時：{pickupDateTime}\n\n受取日当日に現金またはPayPayでお支払いいただきます。\n当日は気をつけてお越しください。\n\n※このメールは自動送信されています。返信はできませんのでご了承ください。\nご不明な点がございましたら、Hyggely公式LINEまでお問い合わせください。'
        },
        detailed: {
          subject: '【予約確認】Hyggelyカンパーニュ専門店 - {orderId}',
          body: '{lastName} {firstName} 様\n\nこの度は、Hyggelyカンパーニュ専門店をご利用いただき、誠にありがとうございます。\n\n━━━━━━━━━━━━━━━━━━━━\n　予約内容確認\n━━━━━━━━━━━━━━━━━━━━\n\n予約ID: {orderId}\nお名前: {lastName} {firstName} 様\nメールアドレス: {email}\n受取日時: {pickupDateTime}\n\n━━━━━━━━━━━━━━━━━━━━\n　ご注文商品\n━━━━━━━━━━━━━━━━━━━━\n\n{orderItems}\n\n合計金額: ¥{totalPrice}\n\n━━━━━━━━━━━━━━━━━━━━\n　お支払い・お受け取りについて\n━━━━━━━━━━━━━━━━━━━━\n\n・お支払い方法: 現金 または PayPay\n・受取場所: 店舗カウンター\n・営業時間: 11:00-17:00（水曜日・土曜日のみ）\n\nご不明な点がございましたら、お気軽にお問い合わせください。\n\n※このメールは自動送信されています。\n\nHyggelyカンパーニュ専門店'
        }
      },
      admin: {
        default: {
          subject: '【新規予約】{lastName} {firstName}様 - {orderId}',
          body: '【新規予約通知】\n\n予約ID: {orderId}\n\nお客様情報:\n・氏名: {lastName} {firstName} 様\n・メール: {email}\n・受取日時: {pickupDateTime}\n\n注文内容:\n{orderItems}\n\n合計金額: ¥{totalPrice}\n\n※予約管理システムより自動送信されています。\n※予約のキャンセルや変更が必要な場合は、お客様に直接ご連絡ください。'
        },
        detailed: {
          subject: '【新規予約詳細】{lastName} {firstName}様 - ¥{totalPrice} - {orderId}',
          body: '━━━━━━━━━━━━━━━━━━━━\n新規予約が入りました\n━━━━━━━━━━━━━━━━━━━━\n\n予約ID: {orderId}\n受付日時: ' + new Date().toLocaleString('ja-JP') + '\n\n━━━━━━━━━━━━━━━━━━━━\nお客様情報\n━━━━━━━━━━━━━━━━━━━━\n\n氏名: {lastName} {firstName} 様\nメールアドレス: {email}\n受取日時: {pickupDateTime}\n\n━━━━━━━━━━━━━━━━━━━━\nご注文内容\n━━━━━━━━━━━━━━━━━━━━\n\n{orderItems}\n\n合計金額: ¥{totalPrice}\n\n━━━━━━━━━━━━━━━━━━━━\n対応が必要な作業\n━━━━━━━━━━━━━━━━━━━━\n\n□ 商品の準備\n□ 受取日時の確認\n□ 在庫状況の確認\n\n管理画面: [ダッシュボードURL]\n\n※このメールは予約管理システムより自動送信されています。'
        }
      }
    };

    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      console.log('📧 メール設定画面起動 v5.2 - AK列対応版');
      loadEmailSettings();
      setupEventListeners();
      updateStatus('システム起動完了', 'success');
    });

    // イベントリスナー設定
    function setupEventListeners() {
      // 文字数カウンター
      setupCharCounter('customer-subject', 100);
      setupCharCounter('customer-body', 2000);
      setupCharCounter('admin-subject', 100);
      setupCharCounter('admin-body', 2000);

      // リアルタイムバリデーション
      document.getElementById('admin-email').addEventListener('input', validateEmail);
      document.getElementById('email-reply-to').addEventListener('input', validateEmail);
    }

    // 文字数カウンター設定
    function setupCharCounter(elementId, maxLength) {
      const element = document.getElementById(elementId);
      const counter = document.getElementById(elementId + '-counter');
      
      element.addEventListener('input', function() {
        const length = this.value.length;
        counter.textContent = `${length}/${maxLength}`;
        
        counter.className = 'char-counter';
        if (length > maxLength * 0.8) {
          counter.classList.add('warning');
        }
        if (length > maxLength * 0.95) {
          counter.classList.add('danger');
        }
      });
    }

    // メールバリデーション
    function validateEmail(event) {
      const email = event.target.value;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      
      if (email && !emailRegex.test(email)) {
        event.target.classList.add('is-invalid');
        event.target.classList.remove('is-valid');
      } else if (email) {
        event.target.classList.add('is-valid');
        event.target.classList.remove('is-invalid');
      } else {
        event.target.classList.remove('is-valid', 'is-invalid');
      }
    }

    // メール設定読み込み
    function loadEmailSettings() {
      showLoading();
      updateStatus('設定読み込み中', 'loading');
      
      google.script.run
        .withSuccessHandler(function(settings) {
          currentSettings = settings || {};
          populateForm(currentSettings);
          updateStats();
          hideLoading();
          updateStatus('読み込み完了', 'success');
          showToast('メール設定を読み込みました', 'success');
        })
        .withFailureHandler(function(error) {
          console.error('メール設定取得エラー:', error);
          hideLoading();
          updateStatus('読み込みエラー', 'error');
          showToast('メール設定の読み込みに失敗しました', 'error');
          // デフォルト設定で表示
          populateForm(getDefaultSettings());
          updateStats();
        })
        .getEmailSettings();
    }

    // デフォルト設定取得（v5.2対応版）
    function getDefaultSettings() {
      return {
        adminEmail: 'hyggely2021@gmail.com',
        customerSubject: defaultTemplates.customer.default.subject,
        customerBody: defaultTemplates.customer.default.body,
        adminSubject: defaultTemplates.admin.default.subject,
        adminBody: defaultTemplates.admin.default.body,
        emailEnabled: true,
        fromName: 'Hyggelyカンパーニュ専門店',
        replyTo: 'noreply@hyggely.com'
      };
    }

    // フォームに設定値を反映
    function populateForm(settings) {
      document.getElementById('admin-email').value = settings.adminEmail || '';
      document.getElementById('customer-subject').value = settings.customerSubject || '';
      document.getElementById('customer-body').value = settings.customerBody || '';
      document.getElementById('admin-subject').value = settings.adminSubject || '';
      document.getElementById('admin-body').value = settings.adminBody || '';
      document.getElementById('email-enabled').checked = settings.emailEnabled !== false;
      document.getElementById('email-from-name').value = settings.fromName || '';
      document.getElementById('email-reply-to').value = settings.replyTo || '';

      // 文字数カウンター更新
      ['customer-subject', 'customer-body', 'admin-subject', 'admin-body'].forEach(id => {
        const element = document.getElementById(id);
        element.dispatchEvent(new Event('input'));
      });
    }

    // 統計更新
    function updateStats() {
      // 実際の統計データを取得する場合は、Google Apps Scriptから取得
      document.getElementById('emails-sent-today').textContent = '0'; // 実装予定
      document.getElementById('total-templates').textContent = '4'; // v5.2で4種類のテンプレート
      document.getElementById('last-test-status').textContent = '未実行';
      document.getElementById('system-status').textContent = currentSettings.emailEnabled ? '有効' : '無効';
    }

    // テンプレート選択
    function selectTemplate(type, template) {
      const templateData = defaultTemplates[type][template];
      
      if (type === 'customer') {
        document.getElementById('customer-subject').value = templateData.subject;
        document.getElementById('customer-body').value = templateData.body;
      } else {
        document.getElementById('admin-subject').value = templateData.subject;
        document.getElementById('admin-body').value = templateData.body;
      }

      // テンプレートカードの選択状態更新
      document.querySelectorAll(`[data-template^="${type}-"]`).forEach(card => {
        card.classList.remove('active');
      });
      document.querySelector(`[data-template="${type}-${template}"]`).classList.add('active');

      // 文字数カウンター更新
      ['customer-subject', 'customer-body', 'admin-subject', 'admin-body'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.dispatchEvent(new Event('input'));
      });

      showToast(`${type === 'customer' ? '顧客' : '管理者'}テンプレートを適用しました`, 'success');
    }

    // 変数挿入
    function insertVariable(textareaId, variable) {
      const textarea = document.getElementById(textareaId);
      const cursorPos = textarea.selectionStart;
      const textBefore = textarea.value.substring(0, cursorPos);
      const textAfter = textarea.value.substring(textarea.selectionEnd);
      
      textarea.value = textBefore + variable + textAfter;
      textarea.focus();
      textarea.setSelectionRange(cursorPos + variable.length, cursorPos + variable.length);

      // アニメーション効果
      const tag = event.target.closest('.variable-tag');
      tag.classList.add('copied');
      setTimeout(() => tag.classList.remove('copied'), 500);
      
      showToast(`変数 ${variable} を挿入しました`, 'success');
      
      // 文字数カウンター更新
      textarea.dispatchEvent(new Event('input'));
    }

    // プレビュー機能（v5.2対応版）
    function previewCustomerEmail() {
      const subject = document.getElementById('customer-subject').value;
      const body = document.getElementById('customer-body').value;
      
      const sampleData = {
        lastName: '山田',
        firstName: '太郎',
        email: 'yamada@example.com',
        orderItems: '・プレミアムカンパーニュ　1個　¥1,000\n・レーズン&クルミ　2個　¥2,400',
        totalPrice: '3,400',
        pickupDateTime: '2025年01月15日 14:00',
        orderId: 'ORD250115140030' // v5.2対応の予約ID
      };

      const previewSubject = replaceVariables(subject, sampleData);
      const previewBody = replaceVariables(body, sampleData);

      const preview = document.getElementById('customer-preview');
      preview.innerHTML = `
        <div class="preview-header">
          <i class="bi bi-envelope me-2"></i>顧客確認メールプレビュー（v5.2対応）
        </div>
        <div class="email-preview">
          <strong>件名:</strong> ${escapeHtml(previewSubject)}<br><br>
          <strong>本文:</strong><br>
          <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${escapeHtml(previewBody)}</pre>
        </div>
      `;
      preview.style.display = 'block';
      preview.scrollIntoView({ behavior: 'smooth' });
    }

    function previewAdminEmail() {
      const subject = document.getElementById('admin-subject').value;
      const body = document.getElementById('admin-body').value;
      
      const sampleData = {
        lastName: '山田',
        firstName: '太郎',
        email: 'yamada@example.com',
        orderItems: '・プレミアムカンパーニュ　1個　¥1,000\n・レーズン&クルミ　2個　¥2,400',
        totalPrice: '3,400',
        pickupDateTime: '2025年01月15日 14:00',
        orderId: 'ORD250115140030' // v5.2対応の予約ID
      };

      const previewSubject = replaceVariables(subject, sampleData);
      const previewBody = replaceVariables(body, sampleData);

      const preview = document.getElementById('admin-preview');
      preview.innerHTML = `
        <div class="preview-header">
          <i class="bi bi-envelope-exclamation me-2"></i>管理者通知メールプレビュー（v5.2対応）
        </div>
        <div class="email-preview">
          <strong>件名:</strong> ${escapeHtml(previewSubject)}<br><br>
          <strong>本文:</strong><br>
          <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${escapeHtml(previewBody)}</pre>
        </div>
      `;
      preview.style.display = 'block';
      preview.scrollIntoView({ behavior: 'smooth' });
    }

    // テストメール送信
    function sendTestEmail(type) {
      const email = document.getElementById('admin-email').value;
      if (!email) {
        showToast('管理者メールアドレスを設定してください', 'error');
        return;
      }

      updateStatus('テストメール送信中', 'loading');
      showToast('テストメールを送信しています...', 'info');

      // 実際のテストメール送信処理（実装予定）
      setTimeout(() => {
        updateStatus('送信完了', 'success');
        showToast(`${type === 'customer' ? '顧客' : '管理者'}テストメールを送信しました（予約ID付き）`, 'success');
      }, 2000);
    }

    // テスト送信実行
    function executeEmailTest() {
      const testEmail = document.getElementById('test-email').value;
      const testType = document.getElementById('test-type').value;

      if (!testEmail) {
        showToast('テスト送信先メールアドレスを入力してください', 'error');
        return;
      }

      updateStatus('テストメール送信中', 'loading');

      // 実際のテスト送信処理（実装予定）
      setTimeout(() => {
        const results = document.getElementById('test-results');
        const message = document.getElementById('test-result-message');
        
        message.textContent = `${testEmail} にテストメール（${testType}・予約ID付き）を送信しました。`;
        results.style.display = 'block';
        results.scrollIntoView({ behavior: 'smooth' });
        
        updateStatus('送信完了', 'success');
        showToast('テストメール送信完了', 'success');
      }, 2000);
    }

    // テンプレート保存
    function saveTemplate(type) {
      const templateName = prompt(`${type === 'customer' ? '顧客' : '管理者'}テンプレートの名前を入力してください:`);
      if (!templateName) return;

      const subject = document.getElementById(`${type}-subject`).value;
      const body = document.getElementById(`${type}-body`).value;

      if (!templateLibrary[type]) templateLibrary[type] = {};
      templateLibrary[type][templateName] = { subject, body };

      showToast(`テンプレート「${templateName}」を保存しました`, 'success');
    }

    // テンプレートリセット
    function resetCustomerTemplate() {
      if (confirm('顧客確認メールテンプレートをデフォルト（v5.2対応版）に戻しますか？')) {
        selectTemplate('customer', 'default');
        document.getElementById('customer-preview').style.display = 'none';
        showToast('顧客メールテンプレートをデフォルトに戻しました', 'success');
      }
    }

    function resetAdminTemplate() {
      if (confirm('管理者通知メールテンプレートをデフォルト（v5.2対応版）に戻しますか？')) {
        selectTemplate('admin', 'default');
        document.getElementById('admin-preview').style.display = 'none';
        showToast('管理者メールテンプレートをデフォルトに戻しました', 'success');
      }
    }

    // 設定保存
    function saveEmailSettings() {
      const adminEmail = document.getElementById('admin-email').value;
      const customerSubject = document.getElementById('customer-subject').value;
      const customerBody = document.getElementById('customer-body').value;
      const adminSubject = document.getElementById('admin-subject').value;
      const adminBody = document.getElementById('admin-body').value;

      // バリデーション
      if (!adminEmail || !customerSubject || !customerBody || !adminSubject || !adminBody) {
        showToast('すべての必須項目を入力してください', 'error');
        return;
      }

      if (!isValidEmail(adminEmail)) {
        showToast('有効な管理者メールアドレスを入力してください', 'error');
        return;
      }

      const settings = {
        adminEmail: adminEmail,
        customerSubject: customerSubject,
        customerBody: customerBody,
        adminSubject: adminSubject,
        adminBody: adminBody,
        emailEnabled: document.getElementById('email-enabled').checked,
        fromName: document.getElementById('email-from-name').value,
        replyTo: document.getElementById('email-reply-to').value
      };

      const button = event.target;
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<div class="spinner-border spinner-border-sm me-1"></div>保存中...';
      updateStatus('設定保存中', 'loading');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.success) {
            currentSettings = settings;
            showToast(result.message || '設定を保存しました（v5.2対応版）', 'success');
            updateStatus('保存完了', 'success');
            
            // 成功表示
            button.classList.remove('btn-success');
            button.classList.add('save-success');
            button.innerHTML = '<i class="bi bi-check-circle me-2"></i>保存完了';
            
            setTimeout(() => {
              button.classList.remove('save-success');
              button.classList.add('btn-success');
              button.innerHTML = originalText;
              button.disabled = false;
            }, 2000);
          } else {
            showToast(result ? result.message : '保存に失敗しました', 'error');
            updateStatus('保存エラー', 'error');
            button.disabled = false;
            button.innerHTML = originalText;
          }
        })
        .withFailureHandler(function(error) {
          console.error('メール設定保存エラー:', error);
          showToast('メール設定の保存に失敗しました: ' + error, 'error');
          updateStatus('保存エラー', 'error');
          button.disabled = false;
          button.innerHTML = originalText;
        })
        .updateEmailSettings(settings);
    }

    // 設定検証
    function validateAllSettings() {
      updateStatus('設定検証中', 'loading');
      
      let isValid = true;
      const errors = [];

      // 必須フィールドチェック
      const requiredFields = ['admin-email', 'customer-subject', 'customer-body', 'admin-subject', 'admin-body'];
      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
          errors.push(`${field.labels[0].textContent}は必須です`);
          isValid = false;
        }
      });

      // メールアドレス形式チェック
      const emailFields = ['admin-email', 'email-reply-to'];
      emailFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field.value && !isValidEmail(field.value)) {
          errors.push(`${field.labels[0].textContent}の形式が正しくありません`);
          isValid = false;
        }
      });

      // v5.2対応チェック：{orderId}変数が含まれているか
      const customerBody = document.getElementById('customer-body').value;
      const adminBody = document.getElementById('admin-body').value;
      
      if (!customerBody.includes('{orderId}')) {
        errors.push('顧客メール本文に{orderId}変数の追加を推奨します（v5.2対応）');
      }
      if (!adminBody.includes('{orderId}')) {
        errors.push('管理者メール本文に{orderId}変数の追加を推奨します（v5.2対応）');
      }

      setTimeout(() => {
        if (isValid) {
          updateStatus('検証完了', 'success');
          showToast('すべての設定が正常です（v5.2対応）', 'success');
        } else {
          updateStatus('検証エラー', 'error');
          showToast('設定に問題があります:\n' + errors.join('\n'), 'error');
        }
      }, 1000);
    }

    // エクスポート・インポート機能
    function exportSettings() {
      const settings = {
        ...currentSettings,
        exportDate: new Date().toISOString(),
        version: '5.2.0' // v5.2対応版
      };

      const dataStr = JSON.stringify(settings, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `hyggely-email-settings-v5.2-${new Date().toISOString().split('T')[0]}.json`;
      link.click();

      showToast('設定をエクスポートしました（v5.2対応版）', 'success');
    }

    function importSettings() {
      const fileInput = document.getElementById('import-file');
      const file = fileInput.files[0];

      if (!file) {
        showToast('インポートするファイルを選択してください', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const settings = JSON.parse(e.target.result);
          
          // バージョンチェック
          if (settings.version && settings.version !== '5.2.0') {
            showToast(`異なるバージョン（${settings.version}）の設定ファイルです。{orderId}変数が正しく含まれているか確認してください。`, 'warning');
          }
          
          populateForm(settings);
          showToast('設定をインポートしました', 'success');
        } catch (error) {
          showToast('ファイルの読み込みに失敗しました', 'error');
        }
      };
      reader.readAsText(file);
    }

    function resetToFactory() {
      if (confirm('本当にすべての設定を工場出荷時の状態（v5.2対応版）に戻しますか？\n\nこの操作は取り消せません。')) {
        populateForm(getDefaultSettings());
        showToast('工場出荷時設定に戻しました（v5.2対応版）', 'warning');
      }
    }

    // ユーティリティ関数
    function replaceVariables(template, data) {
      let result = template;
      Object.keys(data).forEach(key => {
        const regex = new RegExp('{' + key + '}', 'g');
        result = result.replace(regex, data[key]);
      });
      return result;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function showLoading() {
      document.getElementById('loading').classList.add('show');
      document.getElementById('main-content').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
      document.getElementById('main-content').style.display = 'block';
    }

    function updateStatus(message, type) {
      const status = document.getElementById('status');
      let icon = 'bi-wifi';
      let color = 'rgba(40, 167, 69, 0.9)';
      
      switch (type) {
        case 'loading':
          icon = 'bi-arrow-clockwise';
          color = 'rgba(255, 193, 7, 0.9)';
          break;
        case 'error':
          icon = 'bi-exclamation-triangle';
          color = 'rgba(220, 53, 69, 0.9)';
          break;
        case 'success':
          icon = 'bi-check-circle';
          color = 'rgba(40, 167, 69, 0.9)';
          break;
      }
      
      status.innerHTML = `<i class="${icon}"></i> ${message}`;
      status.style.backgroundColor = color;
    }

    function showToast(message, type = 'success') {
      // 既存のトーストを削除
      document.querySelectorAll('.toast').forEach(toast => {
        const bsToast = bootstrap.Toast.getInstance(toast);
        if (bsToast) bsToast.hide();
      });

      let bgClass = 'bg-success';
      let iconClass = 'bi-check-circle';
      
      switch (type) {
        case 'error':
          bgClass = 'bg-danger';
          iconClass = 'bi-x-circle';
          break;
        case 'warning':
          bgClass = 'bg-warning';
          iconClass = 'bi-exclamation-triangle';
          break;
        case 'info':
          bgClass = 'bg-info';
          iconClass = 'bi-info-circle';
          break;
      }

      const toastHtml = `
        <div class="toast align-items-center text-white ${bgClass} border-0"
             style="position: fixed; top: 100px; right: 20px; z-index: 1100; min-width: 350px;">
          <div class="d-flex">
            <div class="toast-body">
              <i class="${iconClass} me-2"></i>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', toastHtml);
      
      const toastElement = document.body.lastElementChild;
      const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: type === 'error' ? 8000 : 5000
      });
      
      toast.show();

      toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
      });
    }
  </script>
</body>
</html>